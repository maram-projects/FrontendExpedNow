<div class="delivery-management-container">
  <!-- Header Section -->
  <header class="management-header">
    <h2 class="header-title">Delivery Personnel Management</h2>
    <button class="primary-button" (click)="openProfessionalRegisterDialog()">
      <i class="fas fa-plus-circle"></i> Add New Delivery Person
    </button>
  </header>

  <!-- Status Messages -->
  <div class="status-messages">
    <div *ngIf="loading" class="loading-state">
      <div class="spinner"></div>
      <p>Loading delivery team...</p>
    </div>

    <div *ngIf="error" class="error-state">
      <i class="fas fa-exclamation-triangle"></i>
      {{error}}
    </div>

    <div *ngIf="!loading && users.length === 0" class="empty-state">
      <div class="empty-icon">üîç</div>
      <p>No delivery personnel found. Let's add some!</p>
    </div>
  </div>

  <!-- Main Content - Users Table -->
  <main class="management-content" *ngIf="users.length && !loading">
    <div class="responsive-table-container">
      <table class="delivery-personnel-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Role</th>
            <th>Registration Date</th>
            <th>Vehicle Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of users">
            <td class="user-name">{{user.firstName}} {{user.lastName}}</td>
            <td class="user-email">{{user.email}}</td>
            <td class="user-phone">{{user.phone}}</td>
            <td class="user-roles">
              <span class="role-badge" [ngClass]="{'role-professional': isProfessional(user), 'role-temporary': !isProfessional(user)}">
                <i [class]="isProfessional(user) ? 'fas fa-user-tie' : 'fas fa-user-clock'"></i>
                {{ isProfessional(user) ? 'Professional' : 'Temporary' }}
              </span>
            </td>
            <td class="user-date">{{user.dateOfRegistration | date:'mediumDate'}}</td>
            
            <td class="vehicle-status">
              <ng-container *ngIf="isProfessional(user); else temporaryVehicle">
                <!-- Professional delivery - show assigned vehicle or assignment option -->
                <ng-container *ngIf="user.assignedVehicle; else noVehicleOrId">
                  <span class="vehicle-info">
                    {{ user.assignedVehicle.make }} {{ user.assignedVehicle.model }}
                    <span class="license-plate">({{ user.assignedVehicle.licensePlate }})</span>
                  </span>
                </ng-container>
                
                <ng-template #noVehicleOrId>
                  <span class="no-vehicle">
                    <ng-container *ngIf="user.assignedVehicleId; else noVehicle">
                      Vehicle ID: {{ user.assignedVehicleId }}
                    </ng-container>
                    <ng-template #noVehicle>
                      No vehicle assigned
                    </ng-template>
                  </span>
                </ng-template>
              </ng-container>
              
              <ng-template #temporaryVehicle>
                <!-- Temporary delivery - show their own vehicle info -->
                <span class="vehicle-info" *ngIf="user.vehicleType">
                  {{ user.vehicleBrand }} {{ user.vehicleModel }}
                  <span class="license-plate">({{ user.vehiclePlateNumber }})</span>
                </span>
                <span class="no-vehicle" *ngIf="!user.vehicleType">
                  Vehicle info not available
                </span>
              </ng-template>
            </td>
            
            <!-- Actions Column -->
            <td class="user-actions">
              <button class="action-button btn-edit" (click)="showEditUserForm(user)">
                <i class="fas fa-pencil-alt"></i> Edit
              </button>
              <button class="action-button btn-details" (click)="showUserDetails(user)">
                <i class="fas fa-info-circle"></i> Details
              </button>
              
              <!-- Only show Assign button for professionals without vehicle -->
              <button *ngIf="isProfessional(user) && !hasAssignedVehicle(user)" 
                      class="action-button btn-select-vehicle" 
                      (click)="showSelectVehicleForm(user)">
                <i class="fas fa-car"></i> Assign
              </button>

              <!-- Block/Unblock button -->
              <button class="action-button btn-block" 
                      [ngClass]="user.enabled ? 'btn-danger' : 'btn-success'"
                      (click)="user.enabled ? blockUser(user.id!) : enableUser(user.id!)">
                <i class="fas" [ngClass]="user.enabled ? 'fa-ban' : 'fa-check'"></i>
                {{ user.enabled ? 'Block' : 'Enable' }}
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </main>

  <!-- Vehicle Selection Modal -->
  <div class="modal-overlay" *ngIf="showVehicleSelectionForm && userForVehicle">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">üöó Assign Vehicle to {{userForVehicle.firstName}} {{userForVehicle.lastName}}</h3>
        <button type="button" class="btn-close" (click)="closeVehicleSelectionForm()">√ó</button>
      </div>
      <div class="modal-body">
        <div *ngIf="availableVehicles.length === 0" class="no-vehicles-message">
          <div class="empty-state">
            <i class="fas fa-car-crash"></i>
            <p>No vehicles available for assignment. Please add vehicles first.</p>
            <button class="primary-button" (click)="navigateToVehicleManagement()">
              <i class="fas fa-plus"></i> Add Vehicles
            </button>
          </div>
        </div>
        
        <div *ngIf="availableVehicles.length > 0">
          <div class="vehicle-grid">
            <div *ngFor="let vehicle of availableVehicles" 
                 class="vehicle-card" 
                 [ngClass]="{'selected': selectedVehicleId === vehicle.id}"
                 (click)="selectVehicle(vehicle.id!)">
              <div class="vehicle-icon">
                <i [class]="'fas ' + getVehicleIcon(vehicle.vehicleType)"></i>
              </div>
              <div class="vehicle-info">
                <h4>{{vehicle.make}} {{vehicle.model}}</h4>
                <p><i class="fas fa-tag"></i> {{vehicle.licensePlate}}</p>
                <p><i class="fas fa-calendar-alt"></i> {{vehicle.year}}</p>
                <p><i class="fas fa-truck-loading"></i> {{vehicle.maxLoad}} kg</p>
              </div>
            </div>
          </div>
          
          <div class="form-actions">
            <button type="button" class="secondary-button" (click)="closeVehicleSelectionForm()">Cancel</button>
            <button type="button" class="primary-button" 
                    [disabled]="!selectedVehicleId || vehicleSubmitting" 
                    (click)="assignSelectedVehicle()">
              <span *ngIf="vehicleSubmitting" class="spinner-button"></span>
              Assign Vehicle
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- User Details Modal -->
  <div class="modal-overlay" *ngIf="showDetailsDialog && selectedUser">
    <div class="modal-content large-modal">
      <div class="modal-header">
        <h3 class="modal-title">üë§ Delivery Person Details</h3>
        <div class="header-actions">
          <button class="action-button btn-edit" (click)="editUserFromDetails(selectedUser)">
            <i class="fas fa-edit"></i> Edit Profile
          </button>
          <button type="button" class="btn-close" (click)="closeDetailsDialog()">√ó</button>
        </div>
      </div>
      <div class="modal-body">
        <div class="user-profile">
          <div class="user-avatar">
            <i class="fas fa-user-circle"></i>
          </div>
          <div class="user-info">
            <h2>{{selectedUser.firstName}} {{selectedUser.lastName}}</h2>
            <span class="role-badge" [ngClass]="{'role-professional': isProfessional(selectedUser), 'role-temporary': !isProfessional(selectedUser)}">
              {{ isProfessional(selectedUser) ? 'Professional' : 'Temporary' }}
            </span>
            <div class="status-indicators">
              <span class="status-badge" [ngClass]="selectedUser.enabled ? 'status-active' : 'status-inactive'">
                <i class="fas" [ngClass]="selectedUser.enabled ? 'fa-check-circle' : 'fa-times-circle'"></i>
                {{selectedUser.enabled ? 'Active' : 'Inactive'}}
              </span>
              <span class="status-badge" [ngClass]="selectedUser.approved ? 'status-approved' : 'status-pending'">
                <i class="fas" [ngClass]="selectedUser.approved ? 'fa-certificate' : 'fa-clock'"></i>
                {{selectedUser.approved ? 'Approved' : 'Pending'}}
              </span>
            </div>
          </div>
        </div>
        
        <!-- Contact Information Section -->
        <div class="details-section">
          <h3><i class="fas fa-address-book"></i> Contact Information</h3>
          <div class="contact-details">
            <div class="contact-property">
              <span class="property-label"><i class="fas fa-envelope"></i> Email:</span>
              <span>{{selectedUser.email}}</span>
            </div>
            <div class="contact-property">
              <span class="property-label"><i class="fas fa-phone"></i> Phone:</span>
              <span>{{selectedUser.phone}}</span>
            </div>
            <div class="contact-property">
              <span class="property-label"><i class="fas fa-map-marker-alt"></i> Address:</span>
              <span>{{selectedUser.address}}</span>
            </div>
          </div>
        </div>
        
        <!-- Vehicle Information Section -->
        <div class="details-section" *ngIf="isProfessional(selectedUser); else temporaryVehicleDetails">
          <!-- Professional Delivery Vehicle Details -->
          <h3><i class="fas fa-truck"></i> Assigned Company Vehicle</h3>
          <div class="vehicle-details" *ngIf="selectedUser.assignedVehicle && selectedUser.assignedVehicle.id; else noCompanyVehicle">
            <div class="vehicle-display">
              <div class="vehicle-photo-container">
                <img *ngIf="selectedUser.assignedVehicle.photoPath" 
                     [src]="selectedUser.assignedVehicle.photoPath | vehiclePhoto" 
                     alt="{{selectedUser.assignedVehicle.make}} {{selectedUser.assignedVehicle.model}}"
                     class="vehicle-photo">
                <div *ngIf="!selectedUser.assignedVehicle.photoPath" class="no-photo">
                  <i class="fas fa-car" style="font-size: 48px; color: #ccc;"></i>
                  <p>No Photo Available</p>
                </div>
              </div>
              <div class="vehicle-info">
                <h4>{{selectedUser.assignedVehicle.make}} {{selectedUser.assignedVehicle.model}}</h4>
                
                <div class="vehicle-properties">
                  <div class="vehicle-property">
                    <span class="property-label">Type:</span>
                    <span>{{getVehicleTypeName(selectedUser.assignedVehicle.vehicleType)}}</span>
                  </div>
                  <div class="vehicle-property">
                    <span class="property-label">Year:</span>
                    <span>{{selectedUser.assignedVehicle.year}}</span>
                  </div>
                  <div class="vehicle-property">
                    <span class="property-label">License Plate:</span>
                    <span>{{selectedUser.assignedVehicle.licensePlate}}</span>
                  </div>
                  <div class="vehicle-property">
                    <span class="property-label">Capacity:</span>
                    <span>{{selectedUser.assignedVehicle.maxLoad}} kg</span>
                  </div>
                  <div class="vehicle-property">
                    <span class="property-label">Status:</span>
                    <span [ngClass]="selectedUser.assignedVehicle.available ? 'status-available' : 'status-unavailable'">
                      {{selectedUser.assignedVehicle.available ? 'Available' : 'In Use'}}
                    </span>
                  </div>
                </div>
                
                <div class="vehicle-actions">
                  <button class="view-details-btn" 
                          (click)="viewVehicleFromUserDetails(selectedUser.assignedVehicle.id!, selectedUser.id!)">
                    <i class="fas fa-eye"></i> View Vehicle Details
                  </button>
                  <button class="unassign-btn" 
                          (click)="unassignVehicleFromUser(selectedUser.id!)">
                    <i class="fas fa-unlink"></i> Unassign Vehicle
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <ng-template #noCompanyVehicle>
            <div class="no-vehicle">
              <i class="fas fa-car-crash"></i>
              <p>No company vehicle assigned</p>
              <button class="primary-button" (click)="showSelectVehicleForm(selectedUser); closeDetailsDialog()">
                <i class="fas fa-car"></i> Assign Vehicle
              </button>
            </div>
          </ng-template>
        </div>
        
        <ng-template #temporaryVehicleDetails>
          <!-- Temporary Delivery Vehicle Details -->
          <h3><i class="fas fa-user-tag"></i> Personal Vehicle Information</h3>
          <div class="vehicle-details" *ngIf="selectedUser.vehicleType; else noPersonalVehicle">
            <div class="vehicle-display">
              <div class="vehicle-photo-container">
                <div class="no-photo">
                  <i class="fas fa-car" style="font-size: 48px; color: #ccc;"></i>
                  <p>Personal Vehicle</p>
                </div>
              </div>
              <div class="vehicle-info">
                <h4>{{selectedUser.vehicleBrand || 'Unknown Brand'}} {{selectedUser.vehicleModel || 'Unknown Model'}}</h4>
                
                <div class="vehicle-properties">
                  <div class="vehicle-property">
                    <span class="property-label">Type:</span>
                    <span>{{getVehicleTypeName(selectedUser.vehicleType)}}</span>
                  </div>
                  <div class="vehicle-property" *ngIf="selectedUser.vehicleYear">
                    <span class="property-label">Year:</span>
                    <span>{{selectedUser.vehicleYear}}</span>
                  </div>
                  <div class="vehicle-property">
                    <span class="property-label">License Plate:</span>
                    <span>{{selectedUser.vehiclePlateNumber || 'Not provided'}}</span>
                  </div>
                  <div class="vehicle-property" *ngIf="selectedUser.vehicleColor">
                    <span class="property-label">Color:</span>
                    <span>{{selectedUser.vehicleColor}}</span>
                  </div>
                  <div class="vehicle-property">
                    <span class="property-label">Driver License:</span>
                    <span>{{selectedUser.driverLicenseNumber || 'Not provided'}} ({{selectedUser.driverLicenseCategory || 'N/A'}})</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <ng-template #noPersonalVehicle>
            <div class="no-vehicle">
              <i class="fas fa-exclamation-circle"></i>
              <p>No vehicle information provided</p>
              <button class="primary-button" (click)="editUserFromDetails(selectedUser)">
                <i class="fas fa-edit"></i> Add Vehicle Information
              </button>
            </div>
          </ng-template>
        </ng-template>
        
        <!-- Professional Information (for delivery personnel) -->
        <div class="details-section" *ngIf="selectedUser.driverLicenseNumber || selectedUser.preferredZones">
          <h3><i class="fas fa-id-card"></i> Professional Information</h3>
          <div class="professional-details">
            <div class="professional-property" *ngIf="selectedUser.driverLicenseNumber">
              <span class="property-label">Driver License:</span>
              <span>{{selectedUser.driverLicenseNumber}} ({{selectedUser.driverLicenseCategory || 'N/A'}})</span>
            </div>
            <div class="professional-property" *ngIf="selectedUser.preferredZones">
              <span class="property-label">Preferred Zones:</span>
              <span>{{selectedUser.preferredZones}}</span>
            </div>
          </div>
        </div>
        
        <!-- Additional Information Section -->
        <div class="details-section">
          <h3><i class="fas fa-info-circle"></i> Additional Information</h3>
          <div class="additional-details">
            <div class="additional-property">
              <span class="property-label">Registration Date:</span>
              <span>{{selectedUser.dateOfRegistration | date:'mediumDate'}}</span>
            </div>
            <div class="additional-property">
              <span class="property-label">User Type:</span>
              <span>{{selectedUser.userType || 'Not specified'}}</span>
            </div>
            <div class="additional-property" *ngIf="selectedUser.roles && selectedUser.roles.length > 0">
              <span class="property-label">Roles:</span>
              <span>{{selectedUser.roles.join(', ')}}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>