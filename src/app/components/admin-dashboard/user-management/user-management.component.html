<div class="user-management-container">
  <div class="header">
    <h2>User Management</h2>
    <p>Manage all user accounts in the system</p>
  </div>

  @if (error) {
    <div class="error-message">
      {{ error }}
    </div>
  }

  <div class="filters">
    <mat-form-field appearance="outline">
      <mat-label>Filter by Status</mat-label>
      <mat-select [(value)]="filterStatus" (selectionChange)="applyFilters()">
        <mat-option value="">All Statuses</mat-option>
        <mat-option value="pending">Pending</mat-option>
        <mat-option value="active">Active</mat-option>
        <mat-option value="disabled">Disabled</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Filter by Type</mat-label>
      <mat-select [(value)]="filterType" (selectionChange)="applyFilters()">
        <mat-option value="">All Types</mat-option>
        <mat-option value="individual">Individual</mat-option>
        <mat-option value="enterprise">Enterprise</mat-option>
        <mat-option value="temporary">Temporary Driver</mat-option>
        <mat-option value="professional">Professional Driver</mat-option>
        <mat-option value="admin">Admin</mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  @if (loading) {
    <div class="loading-spinner">
      <mat-spinner diameter="50"></mat-spinner>
    </div>
  } @else {
    <div class="table-container">
      <table mat-table [dataSource]="getPaginatedUsers()" class="mat-elevation-z8">
        <!-- Name Column -->
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>Name</th>
          <td mat-cell *matCellDef="let user">{{ user.firstName }} {{ user.lastName }}</td>
        </ng-container>

        <!-- Email Column -->
        <ng-container matColumnDef="email">
          <th mat-header-cell *matHeaderCellDef>Email</th>
          <td mat-cell *matCellDef="let user">{{ user.email }}</td>
        </ng-container>

        <!-- Type Column -->
        <ng-container matColumnDef="type">
          <th mat-header-cell *matHeaderCellDef>Type</th>
          <td mat-cell *matCellDef="let user">{{ getUserTypeDisplay(user.userType) }}</td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let user">
            <mat-chip [color]="getStatusColor(getUserStatus(user))" selected>
              {{ getUserStatus(user) | titlecase }}
            </mat-chip>
          </td>
        </ng-container>

        <!-- Registration Date Column -->
        <ng-container matColumnDef="registrationDate">
          <th mat-header-cell *matHeaderCellDef>Registered</th>
          <td mat-cell *matCellDef="let user">
            {{ user.dateOfRegistration | date:'mediumDate' }}
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let user">
            <button mat-icon-button [matMenuTriggerFor]="menu">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #menu="matMenu">
              @if (!user.approved) {
                <button mat-menu-item (click)="approveUser(user.id!)">
                  <mat-icon color="primary">check_circle</mat-icon>
                  <span>Approve</span>
                </button>
                <button mat-menu-item (click)="rejectUser(user.id!)">
                  <mat-icon color="warn">cancel</mat-icon>
                  <span>Reject</span>
                </button>
              }
              <button mat-menu-item (click)="toggleUserStatus(user)">
                <mat-icon>{{ user.enabled ? 'lock' : 'lock_open' }}</mat-icon>
                <span>{{ user.enabled ? 'Disable' : 'Enable' }}</span>
              </button>
              <button mat-menu-item [routerLink]="['/admin/users', user.id, 'edit']">
                <mat-icon>edit</mat-icon>
                <span>Edit</span>
              </button>
            </mat-menu>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>

      <mat-paginator 
        [length]="totalUsers"
        [pageSize]="pageSize"
        [pageSizeOptions]="pageSizeOptions"
        (page)="onPageChange($event)"
        aria-label="Select page of users">
      </mat-paginator>

      @if (filteredUsers.length === 0) {
        <div class="no-users">
          No users found matching your filters
        </div>
      }
    </div>
  }
</div>