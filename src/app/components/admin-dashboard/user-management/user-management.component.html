<div class="container-fluid delivery-dashboard">
  <div class="dashboard-header">
    <h2 class="title">üöö Delivery Personnel Management</h2>
    
    <!-- Button to add new user -->
    <div class="add-button">
      <button class="btn-add" (click)="showAddUserForm()">
        <i class="fa fa-plus-circle"></i> Add New Delivery Person
      </button>
    </div>
  </div>
  
  <!-- Loading spinner -->
  <div *ngIf="loading" class="loader-container">
    <div class="loader"></div>
    <p>Loading awesome delivery team...</p>
  </div>

  <!-- Error message -->
  <div *ngIf="error" class="error-banner">
    <i class="fa fa-exclamation-triangle"></i>
    {{error}}
  </div>

  <!-- No users message -->
  <div *ngIf="!loading && users.length === 0" class="no-users">
    <div class="empty-illustration">üîç</div>
    <p>No delivery personnel found. Let's add some!</p>
  </div>

  <!-- Users table -->
  <div class="table-container" *ngIf="users.length && !loading">
    <table class="users-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Roles</th>
          <th>Registration Date</th>
          <th>Vehicle Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of users" class="user-row">
          <td class="user-name">{{user.firstName}} {{user.lastName}}</td>
          <td class="user-email">{{user.email}}</td>
          <td class="user-phone">{{user.phone}}</td>
          <td class="user-roles">
            <span *ngFor="let role of user.roles" class="role-badge">
              {{role.replace('ROLE_', '')}}
            </span>
          </td>
          <td class="user-date">{{user.dateOfRegistration | date}}</td>
          <td class="vehicle-status">
            <span *ngIf="hasAssignedVehicle(user)" class="status-badge has-vehicle">
              <i class="fas fa-car"></i> Has Vehicle
            </span>
            <span *ngIf="!hasAssignedVehicle(user)" class="status-badge no-vehicle">
              <i class="fas fa-car-crash"></i> No Vehicle
            </span>
          </td>
          <td class="user-actions">
            <button class="btn-edit" (click)="showEditUserForm(user)">
              <i class="fa fa-pencil"></i> Edit
            </button>
            <button class="btn-block" (click)="blockUser(user.id)">
              <i class="fa fa-ban"></i> Block
            </button>
            <!-- New Create Vehicle Button -->
            <button *ngIf="!hasAssignedVehicle(user)" 
                    class="btn-create-vehicle" 
                    (click)="showCreateVehicleForm(user)">
              <i class="fa fa-car"></i> Create Vehicle
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  
  <!-- User Form -->
  <div *ngIf="formMode === 'add' || formMode === 'edit'" class="user-form-container">
    <div class="form-card">
      <div class="form-header">
        <h3>{{ formMode === 'add' ? 'üÜï Add New Delivery Person' : '‚úèÔ∏è Edit Delivery Person' }}</h3>
        <button type="button" class="btn-close" (click)="formMode = ''">√ó</button>
      </div>
      <div class="form-body">
        <form [formGroup]="userForm" (ngSubmit)="onSubmit()">
          <div class="form-row">
            <div class="form-group">
              <label for="firstName">First Name</label>
              <input type="text" id="firstName" formControlName="firstName" [ngClass]="{'invalid': userForm.get('firstName')?.invalid && userForm.get('firstName')?.touched}">
              <div class="error-message" *ngIf="userForm.get('firstName')?.invalid && userForm.get('firstName')?.touched">
                First name is required
              </div>
            </div>
            <div class="form-group">
              <label for="lastName">Last Name</label>
              <input type="text" id="lastName" formControlName="lastName" [ngClass]="{'invalid': userForm.get('lastName')?.invalid && userForm.get('lastName')?.touched}">
              <div class="error-message" *ngIf="userForm.get('lastName')?.invalid && userForm.get('lastName')?.touched">
                Last name is required
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" formControlName="email" [ngClass]="{'invalid': userForm.get('email')?.invalid && userForm.get('email')?.touched}">
            <div class="error-message" *ngIf="userForm.get('email')?.invalid && userForm.get('email')?.touched">
              Valid email is required
            </div>
          </div>
          
          <div class="form-group" *ngIf="formMode === 'add'">
            <label for="password">Password</label>
            <input type="password" id="password" formControlName="password" [ngClass]="{'invalid': userForm.get('password')?.invalid && userForm.get('password')?.touched}">
            <div class="error-message" *ngIf="userForm.get('password')?.invalid && userForm.get('password')?.touched">
              Password must be at least 6 characters
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="phone">Phone</label>
              <input type="tel" id="phone" formControlName="phone" [ngClass]="{'invalid': userForm.get('phone')?.invalid && userForm.get('phone')?.touched}">
              <div class="error-message" *ngIf="userForm.get('phone')?.invalid && userForm.get('phone')?.touched">
                Phone number is required
              </div>
            </div>
            <div class="form-group">
              <label for="address">Address</label>
              <input type="text" id="address" formControlName="address" [ngClass]="{'invalid': userForm.get('address')?.invalid && userForm.get('address')?.touched}">
              <div class="error-message" *ngIf="userForm.get('address')?.invalid && userForm.get('address')?.touched">
                Address is required
              </div>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="userType">User Type</label>
              <select id="userType" formControlName="userType" class="select-field">
                <option *ngFor="let type of userTypes" [value]="type">
                  {{ type === 'professional' ? 'üèÜ Professional' : '‚è±Ô∏è Temporary' }}
                </option>
              </select>
            </div>
            <div class="form-group">
              <label for="vehicleType">Vehicle Type</label>
              <select id="vehicleType" formControlName="vehicleType" class="select-field">
                <option *ngFor="let type of vehicleTypes" [value]="type.value">
                  {{ type.value === 'MOTORCYCLE' ? 'üèçÔ∏è ' : type.value === 'CAR' ? 'üöó ' : 'üöö ' }}
                  {{ type.display }}
                </option>
              </select>
            </div>
          </div>
          
          <!-- Vehicle selection for new users -->
          <div class="form-group" *ngIf="formMode === 'add' && availableVehicles.length > 0">
            <label for="vehicle">Assign Vehicle</label>
            <select id="vehicle" class="select-field" (change)="onVehicleSelected($event)">
              <option value="">-- Select Vehicle --</option>
              <option *ngFor="let vehicle of availableVehicles" [value]="vehicle.id">
                {{ vehicle.make }} {{ vehicle.model }} ({{ vehicle.licensePlate }})
              </option>
            </select>
          </div>

          <!-- No vehicles available message -->
          <div class="no-vehicles" *ngIf="formMode === 'add' && availableVehicles.length === 0">
            <p>No vehicles available for assignment üò¢</p>
          </div>
          
          <div class="form-actions">
            <button type="button" class="btn-cancel" (click)="formMode = ''">Cancel</button>
            <button type="submit" class="btn-submit" [disabled]="userForm.invalid || formSubmitting">
              <span *ngIf="formSubmitting" class="spinner"></span>
              {{ formMode === 'add' ? 'Add Delivery Person' : 'Save Changes' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <!-- Vehicle Creation Form Modal -->
  <div *ngIf="showVehicleForm && userForVehicle" class="vehicle-form-container">
    <div class="form-card">
      <div class="form-header">
        <h3>üöó Create Vehicle for {{userForVehicle.firstName}} {{userForVehicle.lastName}}</h3>
        <button type="button" class="btn-close" (click)="closeVehicleForm()">√ó</button>
      </div>
      <div class="form-body">
        <form [formGroup]="vehicleForm" (ngSubmit)="onVehicleFormSubmit()">
          <div class="form-row">
            <div class="form-group">
              <label for="make">Make</label>
              <input type="text" id="make" formControlName="make" [ngClass]="{'invalid': vehicleForm.get('make')?.invalid && vehicleForm.get('make')?.touched}">
              <div class="error-message" *ngIf="vehicleForm.get('make')?.invalid && vehicleForm.get('make')?.touched">
                Make is required
              </div>
            </div>
            <div class="form-group">
              <label for="model">Model</label>
              <input type="text" id="model" formControlName="model" [ngClass]="{'invalid': vehicleForm.get('model')?.invalid && vehicleForm.get('model')?.touched}">
              <div class="error-message" *ngIf="vehicleForm.get('model')?.invalid && vehicleForm.get('model')?.touched">
                Model is required
              </div>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="year">Year</label>
              <input type="number" id="year" formControlName="year" [ngClass]="{'invalid': vehicleForm.get('year')?.invalid && vehicleForm.get('year')?.touched}">
              <div class="error-message" *ngIf="vehicleForm.get('year')?.invalid && vehicleForm.get('year')?.touched">
                Valid year is required
              </div>
            </div>
            <div class="form-group">
              <label for="licensePlate">License Plate</label>
              <input type="text" id="licensePlate" formControlName="licensePlate" [ngClass]="{'invalid': vehicleForm.get('licensePlate')?.invalid && vehicleForm.get('licensePlate')?.touched}">
              <div class="error-message" *ngIf="vehicleForm.get('licensePlate')?.invalid && vehicleForm.get('licensePlate')?.touched">
                License plate is required
              </div>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="vehicleType">Vehicle Type</label>
              <select id="vehicleTypeCreate" formControlName="vehicleType" class="select-field">
                <option *ngFor="let type of vehicleTypes" [value]="type.value">
                  {{ type.value === 'MOTORCYCLE' ? 'üèçÔ∏è ' : type.value === 'CAR' ? 'üöó ' : 'üöö ' }}
                  {{ type.display }}
                </option>
              </select>
            </div>
            <div class="form-group">
              <label for="maxLoad">Max Load (kg)</label>
              <input type="number" id="maxLoad" formControlName="maxLoad" [ngClass]="{'invalid': vehicleForm.get('maxLoad')?.invalid && vehicleForm.get('maxLoad')?.touched}">
              <div class="error-message" *ngIf="vehicleForm.get('maxLoad')?.invalid && vehicleForm.get('maxLoad')?.touched">
                Valid max load is required
              </div>
            </div>
          </div>
          
          <div class="form-actions">
            <button type="button" class="btn-cancel" (click)="closeVehicleForm()">Cancel</button>
            <button type="submit" class="btn-submit" [disabled]="vehicleForm.invalid || vehicleSubmitting">
              <span *ngIf="vehicleSubmitting" class="spinner"></span>
              Create & Assign Vehicle
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>