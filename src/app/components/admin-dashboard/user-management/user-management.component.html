<div class="user-management-container">
  <div class="header">
    <h2>User Management</h2>
    <p>Manage all user accounts in the system</p>
  </div>

  @if (error) {
    <div class="error-message mat-elevation-z1" role="alert">
      <mat-icon>error_outline</mat-icon>
      {{ error }}
    </div>
  }

  <div class="filters">
    <mat-form-field appearance="outline">
      <mat-label>Filter by Status</mat-label>
      <mat-select [(value)]="filterStatus" (selectionChange)="applyFilters()">
        <mat-option value="">All Statuses</mat-option>
        <mat-option value="pending">Pending</mat-option>
        <mat-option value="active">Active</mat-option>
        <mat-option value="disabled">Disabled</mat-option>
        <mat-option value="rejected">Rejected</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Filter by Type</mat-label>
      <mat-select [(value)]="filterType" (selectionChange)="applyFilters()">
        <mat-option value="">All Types</mat-option>
        <mat-option value="individual">Individual</mat-option>
        <mat-option value="enterprise">Enterprise</mat-option>
        <mat-option value="temporary">Temporary Driver</mat-option>
        <mat-option value="professional">Professional Driver</mat-option>
        <mat-option value="admin">Admin</mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  @if (loading) {
    <div class="loading-spinner">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Loading users...</p>
    </div>
  } @else {
    <div class="table-container">
      <table mat-table [dataSource]="getPaginatedUsers()" class="mat-elevation-z8">
        <!-- Name Column -->
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>Name</th>
          <td mat-cell *matCellDef="let user">
            <div class="user-name">
              <mat-icon class="avatar-icon">account_circle</mat-icon>
              <span>{{ user.firstName }} {{ user.lastName }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Email Column -->
        <ng-container matColumnDef="email">
          <th mat-header-cell *matHeaderCellDef>Email</th>
          <td mat-cell *matCellDef="let user">
            <a href="mailto:{{ user.email }}" class="email-link">{{ user.email }}</a>
          </td>
        </ng-container>

        <!-- Type Column -->
        <ng-container matColumnDef="type">
          <th mat-header-cell *matHeaderCellDef>Type</th>
          <td mat-cell *matCellDef="let user">
            <span class="user-type-badge" [class]="user.userType">
              {{ getUserTypeDisplay(user.userType) }}
            </span>
          </td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let user">
            <mat-chip 
              [color]="getStatusColor(getUserStatus(user))" 
              [disabled]="false"
              [matTooltip]="getStatusTooltip(user)">
              {{ getUserStatus(user) | titlecase }}
              @if (getUserStatus(user) === 'pending') {
                <mat-icon class="status-icon">schedule</mat-icon>
              }
              @if (getUserStatus(user) === 'active') {
                <mat-icon class="status-icon">check_circle</mat-icon>
              }
              @if (getUserStatus(user) === 'disabled') {
                <mat-icon class="status-icon">block</mat-icon>
              }
              @if (getUserStatus(user) === 'rejected') {
                <mat-icon class="status-icon">cancel</mat-icon>
              }
            </mat-chip>
          </td>
        </ng-container>

        <!-- Registration Date Column -->
        <ng-container matColumnDef="registrationDate">
          <th mat-header-cell *matHeaderCellDef>Registered</th>
          <td mat-cell *matCellDef="let user">
            <span class="registration-date">
              {{ user.dateOfRegistration | date:'mediumDate' }}
              <mat-icon class="date-icon" matTooltip="Created on {{ user.dateOfRegistration | date:'medium' }}">calendar_today</mat-icon>
            </span>
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let user">
            <button mat-icon-button [matMenuTriggerFor]="menu" [disabled]="user.userType === 'admin'">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #menu="matMenu">
              <!-- Approve action (only for pending users) -->
              @if (!user.approved && getUserStatus(user) === 'pending') {
                <button mat-menu-item (click)="approveUser(user.id!)">
                  <mat-icon color="primary">check_circle</mat-icon>
                  <span>Approve</span>
                </button>
              }

              <!-- Reject action (only for pending users) -->
              @if (!user.approved && getUserStatus(user) === 'pending') {
                <button mat-menu-item (click)="rejectUser(user.id!)">
                  <mat-icon color="warn">cancel</mat-icon>
                  <span>Reject</span>
                </button>
              }

              <!-- Enable/Disable action (only for approved users) -->
              @if (user.approved && getUserStatus(user) !== 'rejected') {
                <button mat-menu-item (click)="toggleUserStatus(user)">
                  <mat-icon [color]="user.enabled ? 'warn' : 'primary'">
                    {{ user.enabled ? 'lock' : 'lock_open' }}
                  </mat-icon>
                  <span>{{ user.enabled ? 'Disable' : 'Enable' }}</span>
                </button>
              }

              <!-- Edit action (for all users except rejected) -->
              @if (getUserStatus(user) !== 'rejected') {
                <button mat-menu-item [routerLink]="['/admin/users/edit', user.id]">
                  <mat-icon>edit</mat-icon>
                  <span>Edit</span>
                </button>
              }

              <!-- View details action -->
             <button mat-menu-item (click)="navigateToDetails(user.id)">
  <mat-icon>visibility</mat-icon>
  <span>View Details</span>
</button>
            </mat-menu>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>

      <mat-paginator 
        [length]="totalUsers"
        [pageSize]="pageSize"
        [pageSizeOptions]="pageSizeOptions"
        (page)="onPageChange($event)"
        aria-label="Select page of users">
      </mat-paginator>

      @if (filteredUsers.length === 0) {
        <div class="no-users mat-elevation-z1">
          <mat-icon>search_off</mat-icon>
          <p>No users found matching your filters</p>
          <button mat-stroked-button (click)="resetFilters()">
            <mat-icon>refresh</mat-icon>
            Reset Filters
          </button>
        </div>
      }
    </div>
  }
</div>