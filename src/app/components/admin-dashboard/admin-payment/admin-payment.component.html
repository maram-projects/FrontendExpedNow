<!-- admin-payment.component.html -->
<div class="admin-payment-container" [@slideInUp]>
  <!-- Header Section -->
  <div class="header-section">
    <div class="page-title-section">
      <h1 class="page-title">
        <span class="title-icon">üí≥</span>
        Payment Management
      </h1>
      <p class="page-subtitle">Manage and monitor all payment transactions</p>
    </div>
    
    <div class="header-actions">
      <button 
        class="action-btn refresh-btn"
        (click)="refresh()"
        [disabled]="isLoading"
        [@buttonHover]="buttonStates['refresh'] || 'normal'"
        (mouseenter)="onButtonHover('refresh', true)"
        (mouseleave)="onButtonHover('refresh', false)">
        <span class="btn-icon">üîÑ</span>
        Refresh
      </button>
      
      <button 
        class="action-btn export-btn"
        (click)="exportPayments()"
        [disabled]="isLoading || filteredPayments.length === 0"
        [@buttonHover]="buttonStates['export'] || 'normal'"
        (mouseenter)="onButtonHover('export', true)"
        (mouseleave)="onButtonHover('export', false)">
        <span class="btn-icon">üìä</span>
        Export CSV
      </button>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="stats-grid" [@fadeInScale]>
    <div class="stat-card total-revenue">
      <div class="stat-header">
        <span class="stat-icon">üí∞</span>
        <h3>Total Revenue</h3>
      </div>
      <div class="stat-value">{{ formatCurrency(getTotalAmount()) }}</div>
      <div class="stat-label">Total Amount</div>
    </div>

    <div class="stat-card completed-payments">
      <div class="stat-header">
        <span class="stat-icon">‚úÖ</span>
        <h3>Completed</h3>
      </div>
      <div class="stat-value">{{ getCompletedPaymentsCount() }}</div>
      <div class="stat-label">Successful Payments</div>
    </div>

    <div class="stat-card pending-payments">
      <div class="stat-header">
        <span class="stat-icon">‚è≥</span>
        <h3>Pending</h3>
      </div>
      <div class="stat-value">{{ getPendingPaymentsCount() }}</div>
      <div class="stat-label">Awaiting Processing</div>
    </div>

    <div class="stat-card failed-payments">
      <div class="stat-header">
        <span class="stat-icon">‚ùå</span>
        <h3>Failed</h3>
      </div>
      <div class="stat-value">{{ getFailedPaymentsCount() }}</div>
      <div class="stat-label">Failed Transactions</div>
    </div>

    <div class="stat-card refunded-payments">
      <div class="stat-header">
        <span class="stat-icon">‚Ü©Ô∏è</span>
        <h3>Refunded</h3>
      </div>
      <div class="stat-value">{{ getRefundedPaymentsCount() }}</div>
      <div class="stat-label">Refunded Payments</div>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="filters-section" [@fadeInScale]>
    <div class="filter-group">
      <div class="search-container">
        <span class="search-icon">üîç</span>
        <input
          type="text"
          class="search-input"
          placeholder="Search by Payment ID, Client ID, Delivery ID, or Transaction ID..."
          [(ngModel)]="searchTerm"
          (input)="filterPayments()"
          [disabled]="isLoading">
      </div>

      <div class="status-filter">
        <label class="filter-label">Status Filter:</label>
        <select
          class="status-select"
          [(ngModel)]="selectedStatus"
          (change)="filterPayments()"
          [disabled]="isLoading">
          <option value="ALL">All Statuses</option>
          <option *ngFor="let status of getEnumValues(PaymentStatus)" [value]="status">
            {{ status | titlecase }}
          </option>
        </select>
      </div>
    </div>

    <div class="results-info">
      <span class="results-text">
        Showing {{ filteredPayments.length }} of {{ payments.length }} payments
      </span>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p class="loading-text">Loading payments...</p>
  </div>

  <!-- Payments Table -->
  <div class="table-container" *ngIf="!isLoading" [@staggerList]>
    <div class="table-header">
      <h2 class="table-title">Payment Transactions</h2>
    </div>

    <div class="table-wrapper" *ngIf="filteredPayments.length > 0; else noPayments">
      <table class="payments-table">
        <thead>
          <tr>
            <th class="col-id">Payment ID</th>
            <th class="col-client">Client</th>
            <th class="col-delivery">Delivery</th>
            <th class="col-amount">Amount</th>
            <th class="col-method">Method</th>
            <th class="col-status">Status</th>
            <th class="col-date">Date</th>
            <th class="col-actions">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let payment of filteredPayments; trackBy: trackByPaymentId" 
              class="payment-row" [@fadeInScale]>
            
            <!-- Payment ID -->
            <td class="col-id">
              <div class="payment-id-cell">
                <span class="payment-id" [title]="payment.id">
                  {{ payment.id | shorten:8 }}
                </span>
                <div class="payment-details" *ngIf="payment.transactionId">
                  <small class="transaction-id">
                    Txn: {{ payment.transactionId | shorten:12 }}
                  </small>
                </div>
              </div>
            </td>

            <!-- Client ID -->
            <td class="col-client">
              <div class="client-cell">
                <span class="client-id" [title]="payment.clientId">
                  {{ payment.clientId | shorten:10 }}
                </span>
              </div>
            </td>

            <!-- Delivery ID -->
            <td class="col-delivery">
              <div class="delivery-cell">
                <span *ngIf="payment.deliveryId; else noDelivery" 
                      class="delivery-id" 
                      [title]="payment.deliveryId">
                  {{ payment.deliveryId | shorten:10 }}
                </span>
                <ng-template #noDelivery>
                  <span class="no-delivery">N/A</span>
                </ng-template>
              </div>
            </td>

            <!-- Amount -->
            <td class="col-amount">
              <div class="amount-cell">
                <div class="amount-info">
                
    <!-- Show converted amount for Stripe payments -->
    <div *ngIf="payment.convertedAmount" class="converted-amount">
      ‚âà {{ formatConvertedAmount(payment) }}
    </div>
               <span class="final-amount">
  {{ formatCurrency(payment.finalAmountAfterDiscount, payment.currency) }}
</span>

<!-- For original amount -->
<span *ngIf="payment.discountAmount && payment.discountAmount > 0" 
      class="original-amount">
  <del>{{ formatCurrency(payment.amount, payment.currency) }}</del>
</span>
                </div>
                <div *ngIf="payment.discountCode" class="discount-info">
                  <small class="discount-code">
                    Code: {{ payment.discountCode }}
                  </small>
                </div>
              </div>
            </td>

            <!-- Payment Method -->
            <td class="col-method">
              <div class="method-cell">
                <span class="method-badge">
                  <span class="method-icon">{{ getPaymentMethodIcon(payment.method) }}</span>
                  <span class="method-text">{{ payment.method | titlecase }}</span>
                </span>
                <div *ngIf="payment.cardLast4" class="card-info">
                  <small>
                    {{ payment.cardBrand }} ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ {{ payment.cardLast4 }}
                  </small>
                </div>
              </div>
            </td>

            <!-- Status -->
            <td class="col-status">
              <div class="status-cell">
                <span class="status-badge" [ngClass]="getStatusClass(payment.status)">
                  {{ payment.status | titlecase }}
                </span>
                <div *ngIf="payment.deliveryPersonPaid" class="delivery-paid-indicator">
                  <small class="paid-indicator">‚úì Paid to Delivery</small>
                </div>
              </div>
            </td>

            <!-- Date -->
            <td class="col-date">
              <div class="date-cell">
                <div class="date-info">
                  <span class="date-primary">
                    {{ formatDateOnly(payment.paymentDate) }}
                  </span>
                  <small class="date-time">
                    {{ formatTimeOnly(payment.paymentDate) }}
                  </small>
                </div>
              </div>
            </td>

            <!-- Actions -->
            <td class="col-actions">
              <div class="actions-cell">
                <div class="action-buttons">
                  
                  <!-- Refund Button -->
                 <button 
    *ngIf="canRefund(payment)"
    class="action-btn refund-btn"
    (click)="refundPayment(payment)" 
    [title]="'Refund payment ' + payment.id"
    [@buttonHover]="buttonStates['refund-' + payment.id] || 'normal'"
    (mouseenter)="onButtonHover('refund-' + payment.id, true)"
    (mouseleave)="onButtonHover('refund-' + payment.id, false)">
    <span class="btn-icon">‚Ü©Ô∏è</span>
    <span class="btn-text">Refund</span>
</button>

                  <!-- Cancel Button -->
                  <button 
                    *ngIf="canCancel(payment)"
                    class="action-btn cancel-btn"
                    (click)="cancelPayment(payment.id)"
                    [disabled]="isLoading"
                    [title]="'Cancel payment ' + payment.id"
                    [@buttonHover]="buttonStates['cancel-' + payment.id] || 'normal'"
                    (mouseenter)="onButtonHover('cancel-' + payment.id, true)"
                    (mouseleave)="onButtonHover('cancel-' + payment.id, false)">
                    <span class="btn-icon">‚ùå</span>
                    <span class="btn-text">Cancel</span>
                  </button>

                  <!-- Release to Delivery Button -->
                  <button 
                    *ngIf="canReleaseToDelivery(payment)"
                    class="action-btn release-btn"
                    (click)="releaseToDeliveryPerson(payment.id)"
                    [disabled]="isLoading"
                    [title]="'Release payment to delivery person'"
                    [@buttonHover]="buttonStates['release-' + payment.id] || 'normal'"
                    (mouseenter)="onButtonHover('release-' + payment.id, true)"
                    (mouseleave)="onButtonHover('release-' + payment.id, false)">
                    <span class="btn-icon">üöö</span>
                    <span class="btn-text">Release</span>
                  </button>

                  <!-- Status Update Dropdown -->
                  <div class="status-update-dropdown">
                    <select
                      class="status-update-select"
                      [value]="payment.status"
                      (change)="updatePaymentStatus(payment.id, $any($event.target).value)"
                      [disabled]="isLoading"
                      [title]="'Update status for payment ' + payment.id">
                      <option [value]="payment.status" disabled>
                        Change Status
                      </option>
                      <option *ngFor="let status of getEnumValues(PaymentStatus)" 
                              [value]="status"
                              [disabled]="status === payment.status">
                        {{ status | titlecase }}
                      </option>
                    </select>
                  </div>

                </div>
              </div>
            </td>

          </tr>
        </tbody>
      </table>
    </div>

    <!-- No Payments Message -->
    <ng-template #noPayments>
      <div class="no-payments-container" [@fadeInScale]>
        <div class="no-payments-content">
          <span class="no-payments-icon">üí≥</span>
          <h3 class="no-payments-title">No Payments Found</h3>
          <p class="no-payments-message">
            {{ searchTerm || selectedStatus !== 'ALL' 
               ? 'No payments match your current filters. Try adjusting your search criteria.' 
               : 'No payments have been processed yet.' }}
          </p>
          <button 
            *ngIf="searchTerm || selectedStatus !== 'ALL'"
            class="clear-filters-btn"
            (click)="searchTerm = ''; selectedStatus = 'ALL'; filterPayments()">
            Clear Filters
          </button>
        </div>
      </div>
    </ng-template>
  </div>

  <!-- Footer Section -->
  <div class="footer-section" *ngIf="!isLoading && filteredPayments.length > 0">
  <div class="summary-info">
    <span class="summary-text">
      Total displayed: {{ filteredPayments.length }} payments | 
      Total value: {{ formatCurrency(getFilteredTotalAmount()) }}
    </span>
  </div>
</div>
  </div>
