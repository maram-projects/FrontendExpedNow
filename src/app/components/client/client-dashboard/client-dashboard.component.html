<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExpedNow Client Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Dashboard Base Styles */
        .dashboard-container {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .dashboard-title {
            color: #333;
            font-weight: 700;
            margin: 0;
        }

        .btn-create-delivery {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-create-delivery:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .card-modern {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            margin-bottom: 24px;
        }

        .card-modern:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        /* Profile Card */
        .profile-card .profile-header {
            text-align: center;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            font-size: 32px;
            color: white;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .profile-actions {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .btn-profile {
            border-radius: 12px;
            padding: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-profile:hover {
            transform: translateX(4px);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 20px;
            padding: 24px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }

        .stat-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 8px 0;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .stat-primary { border-left: 4px solid #667eea; }
        .stat-primary .stat-icon { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }

        .stat-warning { border-left: 4px solid #f39c12; }
        .stat-warning .stat-icon { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); }

        .stat-success { border-left: 4px solid #27ae60; }
        .stat-success .stat-icon { background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); }

        .stat-info { border-left: 4px solid #3498db; }
        .stat-info .stat-icon { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); }

        .stat-wave {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, transparent 0%, #667eea 50%, transparent 100%);
            animation: wave 3s ease-in-out infinite;
        }

        @keyframes wave {
            0%, 100% { transform: translateX(-100%); }
            50% { transform: translateX(100%); }
        }

        /* View Toggle */
        .view-toggle {
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }

        .btn-group .btn {
            border-radius: 12px;
            padding: 12px 20px;
            font-weight: 500;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .btn-group .btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
            transform: scale(1.05);
        }

        /* Status Filters */
        .status-filter {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 16px;
        }

        .status-filter-btn {
            border-radius: 20px;
            padding: 8px 16px;
            border: 1px solid #e9ecef;
            background: white;
            color: #666;
            transition: all 0.3s ease;
        }

        .status-filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .status-filter-btn:hover {
            transform: translateY(-2px);
        }

        /* Table Styles */
        .table-modern {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .table-modern thead th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            border: none;
            padding: 16px;
        }

        .table-row-animated {
            transition: all 0.3s ease;
        }

        .table-row-animated:hover {
            background: rgba(102, 126, 234, 0.05);
            transform: scale(1.01);
        }

        /* Status Badges */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-delivered { background: #d4edda; color: #155724; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-transit { background: #cce5ff; color: #004085; }
        .status-cancelled { background: #f8d7da; color: #721c24; }

        /* Action Buttons */
        .btn-action {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 0 4px;
            transition: all 0.3s ease;
        }

        .btn-view { background: #667eea; color: white; }
        .btn-pay { background: #27ae60; color: white; }
        .btn-cancel { background: #e74c3c; color: white; }
        .btn-receipt { background: #f39c12; color: white; }

        .btn-action:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* Loading States */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
        }

        .loading-spinner .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 32px;
            color: white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* AI Assistant Styles */
        .ai-assistant-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 380px;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .ai-assistant-widget.minimized {
            max-width: 60px;
        }

        .chat-toggle-btn {
            position: relative;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.4);
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            overflow: hidden;
        }

        .chat-toggle-btn:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.6);
        }

        .chat-toggle-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
        }

        .chat-toggle-btn:hover::before {
            left: 100%;
        }

        .chat-toggle-btn.has-messages {
            animation: pulseButton 2s infinite;
        }

        @keyframes pulseButton {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .message-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4757;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            animation: bounce 0.6s ease;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .chat-container {
            position: absolute;
            bottom: 70px;
            right: 0;
            width: 380px;
            height: 500px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: slideUp 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .chat-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Ccircle cx='30' cy='30' r='2'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            animation: floatPattern 20s infinite linear;
        }

        @keyframes floatPattern {
            0% { transform: translateX(0); }
            100% { transform: translateX(60px); }
        }

        .assistant-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .assistant-avatar {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            animation: rotate 3s ease-in-out infinite;
        }

        @keyframes rotate {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }

        .assistant-details h6 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        .assistant-details p {
            margin: 4px 0 0 0;
            font-size: 12px;
            opacity: 0.9;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .status-indicator.online {
            background: #2ed573;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.5; }
        }

        .chat-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-icon:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            scroll-behavior: smooth;
        }

        .messages-container::-webkit-scrollbar {
            width: 6px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 3px;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.3);
            border-radius: 3px;
        }

        .welcome-message {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            animation: fadeInUp 0.6s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .welcome-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            animation: wobble 0.8s ease;
        }

        @keyframes wobble {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg) scale(1.1); }
            75% { transform: rotate(5deg) scale(1.1); }
        }

        .help-features {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .help-features li {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            margin: 4px 0;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 12px;
            color: #555;
            font-size: 13px;
            transition: all 0.3s ease;
            animation: slideInLeft 0.6s ease both;
        }

        .help-features li:nth-child(1) { animation-delay: 0.1s; }
        .help-features li:nth-child(2) { animation-delay: 0.2s; }
        .help-features li:nth-child(3) { animation-delay: 0.3s; }
        .help-features li:nth-child(4) { animation-delay: 0.4s; }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .help-features li:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: translateX(4px);
        }

        .message-input-container {
            padding: 16px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
        }

        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            background: white;
            border-radius: 24px;
            padding: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .input-wrapper:focus-within {
            border-color: #667eea;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.2);
        }

        .message-input {
            flex: 1;
            border: none;
            outline: none;
            resize: none;
            font-family: inherit;
            font-size: 14px;
            padding: 8px 12px;
            border-radius: 16px;
            max-height: 100px;
            background: transparent;
            color: #333;
        }

        .send-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .send-btn:hover:not(:disabled) {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .dashboard-header {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 16px;
            }

            .ai-assistant-widget {
                right: 10px;
                bottom: 10px;
                max-width: calc(100vw - 20px);
            }

            .chat-container {
                width: calc(100vw - 20px);
                height: calc(100vh - 100px);
                max-width: 400px;
            }
        }

        /* Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            .dashboard-container {
                background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            }

            .card-modern {
                background: rgba(52, 73, 94, 0.95);
                color: #ecf0f1;
            }

            .chat-container {
                background: rgba(52, 73, 94, 0.95);
                border-color: rgba(255, 255, 255, 0.1);
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid dashboard-container">
        <!-- Error Message -->
        <div *ngIf="errorMessage" class="alert alert-danger">
            {{ errorMessage }}
        </div>

        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <h2 class="dashboard-title">Client Dashboard</h2>
            <button (click)="goToDeliveryRequest()" class="btn btn-primary btn-create-delivery">
                <i class="fas fa-plus me-2"></i> Create Delivery Request
            </button>
        </div>
        
        <div class="row g-4">
            <!-- Left Sidebar -->
            <div class="col-xl-3 col-lg-4">
                <!-- Profile Section -->
                <div class="profile-card card-modern">
                    <div class="card-body">
                        <div class="profile-header">
                            <div class="profile-avatar">
                                <i class="fas fa-user-circle"></i>
                            </div>
                            <h5 class="card-title">Profile</h5>
                            <p class="welcome-text">Welcome, <span class="user-type">{{ userType }}</span>!</p>
                        </div>
                        <div class="profile-actions">
                            <a routerLink="/profile" class="btn btn-outline-primary btn-profile">
                                <i class="fas fa-user me-2"></i>View Profile
                            </a>
                            <a routerLink="/profile/edit" class="btn btn-outline-secondary btn-profile">
                                <i class="fas fa-edit me-2"></i>Edit Profile
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Payment Summary Card -->
                <div class="payment-summary-card card-modern">
                    <div class="card-body">
                        <div class="section-header">
                            <h5 class="card-title">
                                <i class="fas fa-credit-card me-2"></i>Payment Summary
                            </h5>
                        </div>
                        
                        <div class="payment-stats-overview mb-4">
                            <div class="payment-stat-item">
                                <div class="payment-stat-label">Completed Payments</div>
                                <div class="payment-stat-value success">
                                    {{ paymentSummary.totalCompleted }}
<span class="stat-percentage">({{ getPaymentStatusPercentage(PaymentStatus.COMPLETED) }}%)</span>
                                </div>
                            </div>
                            <div class="payment-stat-item">
                                <div class="payment-stat-label">Pending Payments</div>
                                <div class="payment-stat-value warning">
                                    {{ paymentSummary.totalPending }}
<span class="stat-percentage">({{ getPaymentStatusPercentage(PaymentStatus.PENDING) }}%)</span>
                                </div>
                            </div>
                            <div class="payment-stat-item">
                                <div class="payment-stat-label">Failed Payments</div>
                                <div class="payment-stat-value danger">
                                    {{ paymentSummary.totalFailed }}
<span class="stat-percentage">({{ getPaymentStatusPercentage(PaymentStatus.FAILED) }}%)</span>
                                </div>
                            </div>
                        </div>
                        
                        <div *ngIf="stats.unpaidOrders > 0" class="unpaid-alert alert alert-warning mt-3">
                            <div class="alert-content">
                                <i class="fas fa-exclamation-circle"></i>
                                <div>
                                    <strong>{{ stats.unpaidOrders }} unpaid order(s)</strong>
                                    <p>Total amount due: {{ stats.totalUnpaidAmount | currency:'TND' }}</p>
                                </div>
                            </div>
                            <button (click)="payAllUnpaid()" class="btn btn-sm btn-warning">
                                Pay All
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Discounts Section -->
                <div class="discounts-card card-modern">
                    <div class="card-body">
                        <div class="section-header">
                            <h5 class="card-title">
                                <i class="fas fa-tags me-2"></i>My Discounts
                            </h5>
                        </div>
                        <div *ngIf="activeDiscounts.length > 0; else noDiscounts" class="discounts-list">
                            <div *ngFor="let discount of activeDiscounts" class="discount-item">
                                <div class="discount-content">
                                    <div class="discount-percentage">{{ discount.percentage }}% OFF</div>
                                    <p class="discount-description">{{ discount.description }}</p>
                                    <div class="discount-expiry">
                                        <i class="fas fa-clock"></i>
                                        Expires: {{ discount.validUntil | date:'shortDate' }}
                                    </div>
                                </div>
                                <span class="discount-code">{{ discount.code }}</span>
                            </div>
                        </div>
                        <ng-template #noDiscounts>
                            <div class="no-discounts">
                                <i class="fas fa-percentage"></i>
                                <p>No active discounts available</p>
                            </div>
                        </ng-template>
                        <a routerLink="/client/discounts" class="btn btn-outline-primary w-100 btn-view-discounts">
                            View All Discounts
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Main Dashboard Content -->
            <div class="col-xl-9 col-lg-8">
                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card stat-primary">
                        <div class="stat-content">
                            <div class="stat-info">
                                <h6 class="stat-label">Total Orders</h6>
                                <h3 class="stat-value">{{ stats.totalOrders }}</h3>
                                <p class="stat-trend">
                                    <i class="fas fa-arrow-up text-success"></i>
                                    {{ stats.thisMonthOrders }} this month
                                </p>
                            </div>
                            <div class="stat-icon">
                                <i class="fas fa-shopping-bag"></i>
                            </div>
                        </div>
                        <div class="stat-wave"></div>
                    </div>
                    
                    <div class="stat-card stat-warning">
                        <div class="stat-content">
                            <div class="stat-info">
                                <h6 class="stat-label">Pending Orders</h6>
                                <h3 class="stat-value">{{ stats.pendingOrders }}</h3>
                                <p class="stat-trend">
                                    <i class="fas fa-clock text-warning"></i>
                                    In progress
                                </p>
                            </div>
                            <div class="stat-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                        <div class="stat-wave"></div>
                    </div>
                    
                    <div class="stat-card stat-success">
                        <div class="stat-content">
                            <div class="stat-info">
                                <h6 class="stat-label">Completed Orders</h6>
                                <h3 class="stat-value">{{ stats.completedOrders }}</h3>
                                <p class="stat-trend">
                                    <i class="fas fa-check text-success"></i>
                                    {{ stats.paidOrders }} paid
                                </p>
                            </div>
                            <div class="stat-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                        </div>
                        <div class="stat-wave"></div>
                    </div>

                    <div class="stat-card stat-info">
                        <div class="stat-content">
                            <div class="stat-info">
                                <h6 class="stat-label">Payment Rate</h6>
                                <h3 class="stat-value">{{ stats.paymentRate }}%</h3>
                                <p class="stat-trend">
                                    <i class="fas fa-credit-card text-info"></i>
                                    {{ stats.paidOrders }}/{{ stats.completedOrders }} paid
                                </p>
                            </div>
                            <div class="stat-icon">
                                <i class="fas fa-percentage"></i>
                            </div>
                        </div>
                        <div class="stat-wave"></div>
                    </div>
                </div>
                
                <!-- View Toggle -->
                <div class="view-toggle mb-3">
                    <div class="btn-group" role="group">
                        <button type="button" 
                                class="btn btn-outline-primary"
                                [class.active]="selectedView === 'orders'"
                                (click)="changeView('orders')">
                            <i class="fas fa-truck me-2"></i>Orders
                            <span class="badge bg-primary ms-2">{{ stats.totalOrders }}</span>
                        </button>
                        <button type="button" 
                                class="btn btn-outline-primary"
                                [class.active]="selectedView === 'payments'"
                                (click)="changeView('payments')">
                            <i class="fas fa-credit-card me-2"></i>Payments
                            <span class="badge bg-success ms-2">{{ paymentSummary.totalCompleted }}</span>
                        </button>
                        <button type="button" 
                                class="btn btn-outline-primary"
                                [class.active]="selectedView === 'movements'"
                                (click)="changeView('movements')">
                            <i class="fas fa-exchange-alt me-2"></i>Transactions
                            <span class="badge bg-info ms-2">{{ paymentTransactions.length }}</span>
                        </button>
                    </div>
                    
                    <!-- Status Filter for Orders View -->
                    <div *ngIf="selectedView === 'orders'" class="status-filter">
                        <ng-container *ngFor="let status of statusFilters">
                            <button class="btn btn-sm status-filter-btn"
                                    [class.active]="selectedFilter === status"
                                    (click)="filterDeliveries(status)">
                                {{ status | titlecase }}
                                <span *ngIf="status !== 'all'" class="badge">
                                    {{ getStatusCount(status) }}
                                </span>
                            </button>
                        </ng-container>
                    </div>
                </div>

                <!-- Orders View -->
                <div *ngIf="selectedView === 'orders'" class="deliveries-card card-modern">
                    <div class="card-header-modern">
                        <h5 class="section-title">
                            <i class="fas fa-truck me-2"></i>Recent Delivery Requests
                        </h5>
                        <div class="header-actions">
                            <div *ngIf="stats.unpaidOrders > 0" class="unpaid-badge">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                {{ stats.unpaidOrders }} unpaid
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div *ngIf="isLoading" class="loading-container">
                            <div class="loading-spinner">
                                <div class="spinner"></div>
                                <p>Loading your deliveries...</p>
                                <button *ngIf="isLoading" (click)="refreshDashboardData()" 
                                        class="btn btn-sm btn-outline-secondary mt-2">
                                    <i class="fas fa-sync-alt me-1"></i> Retry
                                </button>
                            </div>
                        </div>
                        
                        <div *ngIf="!isLoading && filteredDeliveries.length === 0" class="empty-state">
                            <div class="empty-icon">
                                <i class="fas fa-truck"></i>
                            </div>
                            <h4>{{ getEmptyStateMessage() }}</h4>
                            <p>{{ getEmptyStateDescription() }}</p>
                            <button *ngIf="selectedFilter === 'all'" 
                                    (click)="goToDeliveryRequest()" 
                                    class="btn btn-primary btn-create-first">
                                <i class="fas fa-plus me-2"></i> Create Delivery Request
                            </button>
                        </div>
                        
                        <div *ngIf="!isLoading && filteredDeliveries.length > 0" class="table-container">
                            <div class="table-responsive">
                                <table class="table table-modern">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Delivery To</th>
                                            <th>Date</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                            <th>Payment</th>
                                            <th>Payment Method</th>
                                            <th>Rating</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr *ngFor="let delivery of filteredDeliveries" class="table-row-animated">
                                            <td class="id-cell">#{{ delivery.id.slice(0, 8) || 'N/A' }}</td>
                                            <td class="address-cell">{{ delivery.deliveryAddress || 'N/A' }}</td>
                                            <td class="date-cell">{{ delivery.scheduledDate | date:'mediumDate' }}</td>
                                            <td class="amount-cell">
                                                <div class="amount-info">
                                                    <span class="original-amount" *ngIf="delivery.discountAmount && delivery.discountAmount > 0">
                                                        <s>{{ delivery.originalAmount | currency:'TND' }}</s>
                                                    </span>
                                                    <span class="final-amount">{{ delivery.amount | currency:'TND' }}</span>
                                                    <span class="savings" *ngIf="delivery.discountAmount && delivery.discountAmount > 0">
                                                        <i class="fas fa-tag"></i> -{{ delivery.discountAmount | currency:'TND' }}
                                                    </span>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="status-badge"
                                                      [ngClass]="{
                                                        'status-delivered': delivery.status === 'DELIVERED',
                                                        'status-approved': delivery.status === 'APPROVED',
                                                        'status-pending': delivery.status === 'PENDING',
                                                        'status-assigned': delivery.status === 'ASSIGNED',
                                                        'status-transit': delivery.status === 'IN_TRANSIT',
                                                        'status-cancelled': delivery.status === 'CANCELLED',
                                                        'status-expired': delivery.status === 'EXPIRED'
                                                      }">
                                                    {{ delivery.status || 'UNKNOWN' }}
                                                </span>
                                            </td>
                                            <td class="payment-status-cell">
                                                <ng-container *ngIf="delivery.status === 'DELIVERED'">
                                                    <div class="payment-status-container" 
                                                         [ngClass]="'status-' + (delivery.paymentStatus || 'UNPAID')">
                                                        <i class="status-icon" [ngClass]="getPaymentStatusIcon(delivery.paymentStatus)"></i>
                                                        <span class="status-text">{{ delivery.paymentStatus || 'UNPAID' }}</span>
                                                    </div>
                                                </ng-container>
                                                <span *ngIf="delivery.status !== 'DELIVERED'">-</span>
                                            </td>
                                            <td>
                                                <span *ngIf="delivery.paymentMethod" class="payment-method">
                                                    <i class="fas" [ngClass]="{
                                                        'fa-credit-card': delivery.paymentMethod === 'CREDIT_CARD',
                                                        'fa-money-bill-wave': delivery.paymentMethod === 'CASH',
                                                        'fa-wallet': delivery.paymentMethod === 'WALLET',
                                                        'fa-university': delivery.paymentMethod === 'BANK_TRANSFER'
                                                    }"></i>
                                                    {{ getPaymentMethodLabel(delivery.paymentMethod) }}
                                                </span>
                                                <span *ngIf="!delivery.paymentMethod" class="payment-method-na">-</span>
                                            </td>
                                            <td class="rating-cell">
                                                <ng-container *ngIf="delivery?.status === 'DELIVERED' || delivery?.status === 'RATED'; else noRating">
                                                    <div *ngIf="delivery?.rated" class="rated-stars">
                                                        <span *ngFor="let star of [1,2,3,4,5]">
                                                            <i class="fas fa-star" [class.text-warning]="star <= (delivery?.rating || 0)"></i>
                                                        </span>
                                                    </div>
                                                    <div *ngIf="!delivery?.rated" class="rating-stars">
                                                        <span *ngFor="let star of [1,2,3,4,5]" 
                                                              (click)="rateDelivery(delivery, star)"
                                                              title="Rate {{star}} star">
                                                            <i class="far fa-star" [class.text-warning]="hoverRating >= star" 
                                                               (mouseover)="hoverRating = star"
                                                               (mouseout)="hoverRating = 0"></i>
                                                        </span>
                                                    </div>
                                                    <div *ngIf="!delivery?.rated && delivery?.processing" class="rating-loading">
                                                        <i class="fas fa-spinner fa-spin"></i>
                                                    </div>
                                                </ng-container>
                                                <ng-template #noRating>
                                                    <span>-</span>
                                                </ng-template>
                                            </td>
                                            <td>
                                                <div class="action-buttons">
                                                    <button (click)="viewDeliveryDetails(delivery.id)" 
                                                            class="btn btn-action btn-view" 
                                                            title="View Details">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    
                                                    <!-- Payment buttons -->
                                                    <ng-container *ngIf="delivery.status === 'DELIVERED' && delivery.paymentStatus !== 'COMPLETED'">
                                                        <button *ngIf="delivery.paymentStatus === 'FAILED'"
                                                                class="btn btn-action btn-retry"
                                                                (click)="retryFailedPayment(delivery)"
                                                                title="Retry Payment">
                                                            <i class="fas fa-sync-alt"></i>
                                                        </button>
                                                        <button class="btn btn-action btn-pay"
                                                                (click)="openPaymentDialog(delivery)"
                                                                [disabled]="delivery.processingPayment"
                                                                title="Make Payment">
                                                            <i *ngIf="!delivery.processingPayment" class="fas fa-credit-card"></i>
                                                            <i *ngIf="delivery.processingPayment" class="fas fa-spinner fa-spin"></i>
                                                        </button>
                                                    </ng-container>
                                                    
                                                    <button *ngIf="delivery.paymentStatus === 'COMPLETED'"
                                                            class="btn btn-action btn-receipt"
                                                            (click)="downloadReceipt(delivery)"
                                                            title="Download Receipt">
                                                        <i class="fas fa-receipt"></i>
                                                    </button>
                                                    
                                                    <button *ngIf="delivery.status && ['PENDING', 'ASSIGNED'].includes(delivery.status)"
                                                            class="btn btn-action btn-cancel"
                                                            (click)="cancelDelivery(delivery.id)"
                                                            [disabled]="delivery.processing"
                                                            title="Cancel Order">
                                                        <i *ngIf="!delivery.processing" class="fas fa-times"></i>
                                                        <i *ngIf="delivery.processing" class="fas fa-spinner fa-spin"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="table-footer">
                                <div class="table-info">
                                    <span>Showing {{ filteredDeliveries.length }} of {{ recentDeliveries.length }} deliveries</span>
                                </div>
                                <div class="table-actions">
                                    <button *ngIf="stats.unpaidOrders > 0 && selectedFilter !== 'unpaid'" 
                                            (click)="payAllUnpaid()" 
                                            class="btn btn-warning me-2">
                                        <i class="fas fa-credit-card me-1"></i>
                                        Pay All Unpaid ({{ stats.unpaidOrders }})
                                    </button>
                                    <a routerLink="/client/orders" class="btn btn-outline-primary btn-view-all">
                                        <i class="fas fa-list me-2"></i>View All Orders
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payments View -->
                <div *ngIf="selectedView === 'payments'" class="payments-card card-modern">
                    <div class="card-header-modern">
                        <h5 class="section-title">
                            <i class="fas fa-credit-card me-2"></i>Payment History
                        </h5>
                        <div class="payment-view-options">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" 
                                        [class.active]="true"
                                        (click)="filterPayments('all')">
                                    All Payments
                                </button>
                                <button class="btn btn-outline-success" 
                                        (click)="filterPayments('completed')">
                                    Completed
                                </button>
                                <button class="btn btn-outline-warning" 
                                        (click)="filterPayments('pending')">
                                    Pending
                                </button>
                                <button class="btn btn-outline-danger" 
                                        (click)="filterPayments('failed')">
                                    Failed
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <div *ngIf="isLoading" class="loading-container">
                            <div class="loading-spinner">
                                <div class="spinner"></div>
                                <p>Loading payment history...</p>
                                <button *ngIf="isLoading" (click)="refreshDashboardData()" 
                                        class="btn btn-sm btn-outline-secondary mt-2">
                                    <i class="fas fa-sync-alt me-1"></i> Retry
                                </button>
                            </div>
                        </div>
                        
                        <div *ngIf="!isLoading && getPaymentHistory().length === 0" class="empty-state">
                            <div class="empty-icon">
                                <i class="fas fa-credit-card"></i>
                            </div>
                            <h4>No Payment History</h4>
                            <p>You haven't made any payments yet.</p>
                        </div>
                        
                        <div *ngIf="!isLoading && getPaymentHistory().length > 0" class="table-container">
                            <div class="table-responsive">
                                <table class="table table-modern">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Delivery</th>
                                            <th>Amount</th>
                                            <th>Method</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr *ngFor="let payment of getPaymentHistory()" class="table-row-animated">
                                            <td>{{ (payment.paymentDate | date:'shortDate') || 'N/A' }}</td>
                                            <td>
                                                <a *ngIf="payment.deliveryId" 
                                                   [routerLink]="['/client/orders', payment.deliveryId]"
                                                   class="delivery-link">
                                                   #{{ payment.deliveryId.slice(0, 8) || 'N/A' }}
                                                </a>
                                                <span *ngIf="!payment.deliveryId">-</span>
                                            </td>
                                            <td>{{ payment.amount | currency:'TND' }}</td>
                                            <td>{{ getPaymentMethodLabel(payment.paymentMethod) }}</td>
                                            <td>
                                                <span class="payment-status-badge" 
                                                      [ngClass]="'status-' + payment.status">
                                                    {{ payment.status }}
                                                </span>
                                            </td>
                                            <td>
                                                <div class="payment-actions">
                                                    <button class="btn btn-action btn-view"
                                                            (click)="viewPaymentDetails(payment)"
                                                            title="View Details">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <a *ngIf="payment.receiptUrl" 
                                                       href="{{payment.receiptUrl}}" 
                                                       target="_blank"
                                                       class="btn btn-action btn-receipt"
                                                       title="Download Receipt">
                                                        <i class="fas fa-receipt"></i>
                                                    </a>
                                                    <a *ngIf="payment.invoiceUrl" 
                                                       href="{{payment.invoiceUrl}}" 
                                                       target="_blank"
                                                       class="btn btn-action btn-invoice"
                                                       title="View Invoice">
                                                        <i class="fas fa-file-invoice"></i>
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="table-footer">
                                <div class="table-summary">
                                    <span>Total: {{ getPaymentHistory().length }} payments</span>
                                    <span>Amount: {{ getTotalPaymentsAmount() | currency:'TND' }}</span>
                                </div>
                                <div class="table-pagination">
                                    <!-- Pagination would go here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Transactions View -->
                <div *ngIf="selectedView === 'movements'" class="transactions-card card-modern">
                    <div class="card-header-modern">
                        <h5 class="section-title">
                            <i class="fas fa-exchange-alt me-2"></i>Financial Transactions
                        </h5>
                    </div>
                    
                    <div class="card-body">
                        <div *ngIf="isLoading" class="loading-container">
                            <div class="loading-spinner">
                                <div class="spinner"></div>
                                <p>Loading transactions...</p>
                            </div>
                        </div>
                        
                        <div *ngIf="!isLoading && paymentTransactions.length === 0" class="empty-state">
                            <div class="empty-icon">
                                <i class="fas fa-exchange-alt"></i>
                            </div>
                            <h4>No Transactions Found</h4>
                            <p>Your financial transactions will appear here.</p>
                        </div>
                        
                        <div *ngIf="!isLoading && paymentTransactions.length > 0" class="table-container">
                            <div class="table-responsive">
                                <table class="table table-modern">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Type</th>
                                            <th>Delivery</th>
                                            <th>Amount</th>
                                            <th>Method</th>
                                            <th>Status</th>
                                            <th>Description</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr *ngFor="let transaction of paymentTransactions" class="table-row-animated">
                                            <td>{{ transaction.paymentDate | date:'short' }}</td>
                                            <td>
                                                <span class="transaction-type" 
                                                      [ngClass]="'type-' + transaction.type.toLowerCase()">
                                                    {{ transaction.type }}
                                                </span>
                                            </td>
                                            <td>
                                                <a *ngIf="transaction.deliveryId" 
                                                   [routerLink]="['/client/orders', transaction.deliveryId]"
                                                   class="delivery-link">
                                                   #{{ transaction.deliveryId.slice(0, 8) || 'N/A' }}
                                                </a>
                                                <span *ngIf="!transaction.deliveryId">-</span>
                                            </td>
                                            <td [ngClass]="{
                                                'text-success': transaction.type === 'PAYMENT',
                                                'text-danger': transaction.type === 'REFUND',
                                                'text-info': transaction.type === 'DISCOUNT'
                                            }">
                                                {{ transaction.amount | currency:'TND' }}
                                            </td>
                                            <td>{{ getPaymentMethodLabel(transaction.paymentMethod) }}</td>
                                            <td>
                                                <span class="transaction-status" 
                                                      [ngClass]="'status-' + transaction.status.toLowerCase()">
                                                    {{ transaction.status }}
                                                </span>
                                            </td>
                                            <td>{{ transaction.description }}</td>
                                            <td>
                                                <div class="transaction-actions">
                                                    <button *ngIf="transaction.type === 'PAYMENT' && transaction.id"
                                                            class="btn btn-action btn-view"
                                                            (click)="viewPaymentDetails(transaction)"
                                                            title="View Details">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <a *ngIf="transaction.receiptUrl" 
                                                       href="{{transaction.receiptUrl}}" 
                                                       target="_blank"
                                                       class="btn btn-action btn-receipt"
                                                       title="Download Receipt">
                                                        <i class="fas fa-receipt"></i>
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Assistant Chat Widget -->
    <div class="ai-assistant-widget" [class.minimized]="isMinimized">
        <!-- Chat Toggle Button -->
        <button class="chat-toggle-btn" 
                (click)="toggleChat()" 
                [class.has-messages]="messages.length > 0"
                title="AI Assistant">
            <i class="fas fa-robot" *ngIf="isMinimized"></i>
            <i class="fas fa-times" *ngIf="!isMinimized"></i>
            <span class="message-count" *ngIf="messages.length > 0 && isMinimized">
                {{ messages.length }}
            </span>
        </button>

        <!-- Chat Container -->
        <div class="chat-container" *ngIf="!isMinimized">
            <!-- Chat Header -->
            <div class="chat-header">
                <div class="assistant-info">
                    <div class="assistant-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="assistant-details">
                        <h6 class="assistant-name">ExpedNow Assistant</h6>
                        <p class="assistant-status">
                            <span class="status-indicator online"></span>
                            Always here to help
                        </p>
                    </div>
                </div>
                <div class="chat-actions">
                    <button class="btn-icon" 
                            (click)="startNewConversation()" 
                            title="New Conversation"
                            *ngIf="messages.length > 0">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="btn-icon" 
                            (click)="clearConversation()" 
                            title="Clear Chat"
                            *ngIf="messages.length > 0">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button class="btn-icon" (click)="toggleChat()" title="Minimize">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
            </div>

            <!-- Messages Container -->
            <div class="messages-container" #messagesContainer>
                <!-- Welcome Message -->
                <div class="welcome-message" *ngIf="messages.length === 0">
                    <div class="welcome-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="welcome-content">
                        <h6>Hello, {{ getUserName() }}! </h6>
                        <p>I'm your ExpedNow AI Assistant. I can help you with:</p>
                        <ul class="help-features">
                            <li><i class="fas fa-truck"></i> Track your deliveries</li>
                            <li><i class="fas fa-chart-line"></i> View delivery statistics</li>
                            <li><i class="fas fa-credit-card"></i> Check payment status</li>
                            <li><i class="fas fa-question-circle"></i> Answer questions about our service</li>
                        </ul>
                    </div>
                </div>

               <!-- Messages -->
                <div class="messages-list" *ngIf="messages.length > 0">
                    <div *ngFor="let message of messages; trackBy: trackByMessage" 
                         [ngClass]="getMessageClass(message)">
                        <div class="message-avatar" *ngIf="isAssistantMessage(message)">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="message-content">
                            <div class="message-bubble">
                                <p [innerHTML]="formatMessageContent(message.content)"></p>
                                <div class="message-time">
                                    {{ formatTimestamp(message.timestamp) }}
                                </div>
                            </div>
                        </div>
                        <div class="message-avatar user-avatar" *ngIf="isUserMessage(message)">
                            <i class="fas fa-user"></i>
                        </div>
                    </div>
                    
                    <!-- Typing Indicator -->
                    <div class="typing-indicator" *ngIf="isTyping">
                        <div class="typing-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="typing-content">
                            <div class="typing-bubble">
                                <div class="typing-animation">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Message Input Container -->
            <div class="message-input-container">
                <div class="input-wrapper">
                    <textarea class="message-input" 
                              [(ngModel)]="currentMessage"
                              (keydown.enter)="sendMessage($event)"
                              (input)="adjustTextareaHeight($event)"
                              placeholder="Type your message..."
                              rows="1"
                              [disabled]="isSending"
                              #messageInput></textarea>
                    <button class="send-btn" 
                            (click)="sendMessage()"
                            [disabled]="!currentMessage.trim() || isSending"
                            title="Send Message">
                        <i class="fas fa-paper-plane" *ngIf="!isSending"></i>
                        <i class="fas fa-spinner fa-spin" *ngIf="isSending"></i>
                    </button>
                </div>
                
                <!-- Quick Actions -->
                <div class="quick-actions" *ngIf="messages.length === 0">
                    <div class="quick-action-buttons">
                        <button class="quick-action-btn" (click)="sendQuickMessage('Track my latest delivery')">
                            <i class="fas fa-map-marker-alt"></i>
                            Track Delivery
                        </button>
                        <button class="quick-action-btn" (click)="sendQuickMessage('Show my payment status')">
                            <i class="fas fa-credit-card"></i>
                            Payment Status
                        </button>
                        <button class="quick-action-btn" (click)="sendQuickMessage('Help me create a new delivery')">
                            <i class="fas fa-plus-circle"></i>
                            New Delivery
                        </button>
                        <button class="quick-action-btn" (click)="sendQuickMessage('What are my delivery statistics?')">
                            <i class="fas fa-chart-bar"></i>
                            Statistics
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success/Error Notifications -->
    <div class="notification-container" *ngIf="notifications.length > 0">
        <div *ngFor="let notification of notifications; trackBy: trackByNotification" 
             class="notification"
             [ngClass]="'notification-' + notification.type"
             [@slideIn]>
            <div class="notification-content">
                <i class="notification-icon" 
                   [ngClass]="{
                     'fas fa-check-circle': notification.type === 'success',
                     'fas fa-exclamation-circle': notification.type === 'warning',
                     'fas fa-times-circle': notification.type === 'error',
                     'fas fa-info-circle': notification.type === 'info'
                   }"></i>
                <div class="notification-text">
                    <h6 class="notification-title">{{ notification.title }}</h6>
                    <p class="notification-message">{{ notification.message }}</p>
                </div>
            </div>
            <button class="notification-close" (click)="dismissNotification(notification.id)">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" *ngIf="isPerformingGlobalAction">
        <div class="loading-overlay-content">
            <div class="loading-spinner-large">
                <div class="spinner-large"></div>
            </div>
            <h4>{{ globalActionMessage }}</h4>
            <p>Please wait while we process your request...</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Mock data and functions for demonstration
        let selectedView = 'orders';
        let selectedFilter = 'all';
        let isLoading = false;
        let isMinimized = true;
        let messages = [];
        let currentMessage = '';
        let isSending = false;
        let isTyping = false;
        let notifications = [];
        let isPerformingGlobalAction = false;
        let globalActionMessage = '';
        let hoverRating = 0;

        // Mock stats data
        const stats = {
            totalOrders: 47,
            thisMonthOrders: 8,
            pendingOrders: 3,
            completedOrders: 39,
            paidOrders: 35,
            unpaidOrders: 4,
            paymentRate: 90,
            totalUnpaidAmount: 245.50
        };

        const paymentSummary = {
            totalCompleted: 35,
            totalPending: 4,
            totalFailed: 2
        };

        const filteredDeliveries = [
            {
                id: 'del001-abc-def-123',
                deliveryAddress: '123 Main Street, Tunis',
                scheduledDate: new Date(),
                amount: 85.50,
                originalAmount: 95.00,
                discountAmount: 9.50,
                status: 'DELIVERED',
                paymentStatus: 'COMPLETED',
                paymentMethod: 'CREDIT_CARD',
                rated: true,
                rating: 5,
                processing: false,
                processingPayment: false
            },
            {
                id: 'del002-xyz-uvw-456',
                deliveryAddress: '456 Oak Avenue, Sfax',
                scheduledDate: new Date(Date.now() - 86400000),
                amount: 127.25,
                status: 'IN_TRANSIT',
                paymentStatus: 'PENDING',
                paymentMethod: null,
                rated: false,
                processing: false,
                processingPayment: false
            }
        ];

        const recentDeliveries = filteredDeliveries;
        const paymentTransactions = [];
        const activeDiscounts = [];
        const statusFilters = ['all', 'pending', 'delivered', 'cancelled'];

        // Mock functions
        function changeView(view) {
            selectedView = view;
            console.log('Changed view to:', view);
        }

        function filterDeliveries(status) {
            selectedFilter = status;
            console.log('Filtered deliveries by:', status);
        }

        function getStatusCount(status) {
            if (status === 'pending') return stats.pendingOrders;
            if (status === 'delivered') return stats.completedOrders;
            return 0;
        }

        function getEmptyStateMessage() {
            if (selectedFilter === 'all') return 'No Delivery Requests Found';
            return `No ${selectedFilter} orders found`;
        }

        function getEmptyStateDescription() {
            if (selectedFilter === 'all') return 'Start by creating your first delivery request.';
            return `You don't have any ${selectedFilter} orders at the moment.`;
        }

        function getPaymentStatusIcon(status) {
            if (status === 'COMPLETED') return 'fas fa-check-circle text-success';
            if (status === 'PENDING') return 'fas fa-clock text-warning';
            if (status === 'FAILED') return 'fas fa-times-circle text-danger';
            return 'fas fa-question-circle text-muted';
        }

        function getPaymentMethodLabel(method) {
            const labels = {
                'CREDIT_CARD': 'Credit Card',
                'CASH': 'Cash',
                'WALLET': 'Digital Wallet',
                'BANK_TRANSFER': 'Bank Transfer'
            };
            return labels[method] || 'Unknown';
        }

        function getPaymentHistory() {
            return [];
        }

        function getTotalPaymentsAmount() {
            return 0;
        }

        function refreshDashboardData() {
            isLoading = true;
            setTimeout(() => {
                isLoading = false;
            }, 2000);
        }

        // AI Assistant Functions
        function toggleChat() {
            isMinimized = !isMinimized;
        }

        function getUserName() {
            return 'Client';
        }

        function sendMessage(event) {
            if (event && event.shiftKey) return;
            if (event) event.preventDefault();
            
            if (!currentMessage.trim() || isSending) return;

            const userMessage = {
                id: Date.now(),
                content: currentMessage.trim(),
                type: 'user',
                timestamp: new Date()
            };

            messages.push(userMessage);
            currentMessage = '';
            isSending = true;
            isTyping = true;

            // Simulate AI response
            setTimeout(() => {
                isTyping = false;
                const aiMessage = {
                    id: Date.now() + 1,
                    content: generateAIResponse(userMessage.content),
                    type: 'assistant',
                    timestamp: new Date()
                };
                messages.push(aiMessage);
                isSending = false;
            }, 2000);
        }

        function sendQuickMessage(message) {
            currentMessage = message;
            sendMessage();
        }

        function generateAIResponse(userMessage) {
            const responses = [
                "I understand you'd like help with that. Based on your dashboard data, I can see you have " + stats.totalOrders + " total orders.",
                "Let me help you with that request. Your current payment rate is " + stats.paymentRate + "%.",
                "I can assist you with tracking your deliveries. You have " + stats.pendingOrders + " pending orders.",
                "Thank you for your question. I'm here to help you manage your ExpedNow account effectively."
            ];
            return responses[Math.floor(Math.random() * responses.length)];
        }

        function isAssistantMessage(message) {
            return message.type === 'assistant';
        }

        function isUserMessage(message) {
            return message.type === 'user';
        }

        function getMessageClass(message) {
            return 'message message-' + message.type;
        }

        function formatMessageContent(content) {
            return content.replace(/\n/g, '<br>');
        }

        function formatTimestamp(timestamp) {
            return new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        function trackByMessage(index, message) {
            return message.id;
        }

        function clearConversation() {
            messages = [];
        }

        function startNewConversation() {
            clearConversation();
        }

        function adjustTextareaHeight(event) {
            const textarea = event.target;
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
        }

        // Action Functions
        function goToDeliveryRequest() {
            console.log('Navigate to delivery request');
        }

        function viewDeliveryDetails(id) {
            console.log('View delivery details:', id);
        }

        function openPaymentDialog(delivery) {
            console.log('Open payment dialog for:', delivery);
        }

        function retryFailedPayment(delivery) {
            console.log('Retry payment for:', delivery);
        }

        function downloadReceipt(delivery) {
            console.log('Download receipt for:', delivery);
        }

        function cancelDelivery(id) {
            console.log('Cancel delivery:', id);
        }

        function rateDelivery(delivery, rating) {
            console.log('Rate delivery:', delivery, 'Rating:', rating);
        }

        function payAllUnpaid() {
            console.log('Pay all unpaid orders');
        }

        function filterPayments(filter) {
            console.log('Filter payments by:', filter);
        }

        function viewPaymentDetails(payment) {
            console.log('View payment details:', payment);
        }

        // Notification Functions
        function trackByNotification(index, notification) {
            return notification.id;
        }

        function dismissNotification(id) {
            notifications = notifications.filter(n => n.id !== id);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ExpedNow Client Dashboard Loaded');
        });
    </script>

    <style>
        /* Additional styles for chat messages and notifications */
        .messages-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            animation: fadeInUp 0.3s ease;
        }

        .message-user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .user-avatar {
            background: linear-gradient(135deg, #2ed573 0%, #17a2b8 100%);
            color: white;
        }

        .message-content {
            max-width: 75%;
            min-width: 120px;
        }

        .message-bubble {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 18px;
            padding: 12px 16px;
            position: relative;
        }

        .message-user .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message-bubble p {
            margin: 0;
            font-size: 14px;
            line-height: 1.4;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 4px;
            text-align: right;
        }

        .typing-indicator {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            opacity: 0.8;
        }

        .typing-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: white;
        }

        .typing-bubble {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 18px;
            padding: 12px 16px;
        }

        .typing-animation {
            display: flex;
            gap: 4px;
        }

        .typing-animation span {
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            animation: typing 1.4s ease-in-out infinite both;
        }

        .typing-animation span:nth-child(1) { animation-delay: -0.32s; }
        .typing-animation span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .quick-actions {
            margin-top: 12px;
        }

        .quick-action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .quick-action-btn {
            padding: 8px 12px;
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 12px;
            background: white;
            color: #667eea;
            font-size: 12px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }

        .quick-action-btn:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: #667eea;
        }

        /* Notification Styles */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 400px;
        }

        .notification {
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            margin-bottom: 16px;
            padding: 16px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            position: relative;
            animation: slideIn 0.3s ease;
        }

        .notification-success { border-left: 4px solid #27ae60; }
        .notification-warning { border-left: 4px solid #f39c12; }
        .notification-error { border-left: 4px solid #e74c3c; }
        .notification-info { border-left: 4px solid #3498db; }

        .notification-icon {
            font-size: 20px;
            margin-top: 2px;
        }

        .notification-success .notification-icon { color: #27ae60; }
        .notification-warning .notification-icon { color: #f39c12; }
        .notification-error .notification-icon { color: #e74c3c; }
        .notification-info .notification-icon { color: #3498db; }

        .notification-text {
            flex: 1;
        }

        .notification-title {
            margin: 0 0 4px 0;
            font-size: 14px;
            font-weight: 600;
        }

        .notification-message {
            margin: 0;
            font-size: 13px;
            color: #666;
            line-height: 1.4;
        }

        .notification-close {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            border: none;
            background: none;
            color: #999;
            cursor: pointer;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .notification-close:hover {
            background: rgba(0, 0, 0, 0.1);
            color: #666;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
        }

        .loading-overlay-content {
            background: white;
            padding: 40px;
            border-radius: 16px;
            text-align: center;
            max-width: 300px;
        }

        .loading-spinner-large {
            margin-bottom: 20px;
        }

        .spinner-large {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Additional responsive improvements */
        @media (max-width: 480px) {
            .quick-action-buttons {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</body>
</html>