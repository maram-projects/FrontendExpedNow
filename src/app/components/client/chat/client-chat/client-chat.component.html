<!-- client-chat.component.html (with sidebar functionality) -->
<div class="chat-layout" [class.loading]="isLoading" [class.error]="hasError">
  
  <!-- Left Sidebar - Chat Rooms List -->
  <div class="chat-sidebar" 
       [class.collapsed]="isSidebarCollapsed"
       [class.show-mobile]="showMobileSidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">
        <h3>My Chats</h3>
        <span class="chat-count" *ngIf="rooms.length > 0">({{ rooms.length }})</span>
      </div>
      <button class="sidebar-toggle" 
              (click)="toggleSidebar()"
              [attr.aria-label]="isSidebarCollapsed ? 'Expand sidebar' : 'Collapse sidebar'">
        <span class="toggle-icon" [class.collapsed]="isSidebarCollapsed">‚Äπ</span>
      </button>
    </div>

    <!-- Chat Rooms List -->
    <div class="chat-rooms-container">
      <div *ngIf="isLoading && rooms.length === 0" class="loading-rooms">
        <div class="skeleton-room" *ngFor="let item of [1,2,3]">
          <div class="skeleton-avatar"></div>
          <div class="skeleton-content">
            <div class="skeleton-line"></div>
            <div class="skeleton-line short"></div>
          </div>
        </div>
      </div>

      <div class="chat-rooms-list" *ngIf="!isLoading || rooms.length > 0">
        <div *ngFor="let room of rooms; trackBy: trackByRoomId"
             class="chat-room-item"
             [class.active]="selectedRoom?.deliveryId === room.deliveryId"
             [class.has-unread]="room.unreadCount > 0"
             (click)="selectRoom(room)"
             role="button"
             [attr.aria-label]="'Chat with ' + getRoomDisplayName(room)">
          
          <div class="room-avatar">
            <div class="avatar-circle">
              {{ getRoomDisplayName(room).charAt(0).toUpperCase() }}
            </div>
            <div class="online-indicator" 
                 *ngIf="isUserOnline(getOtherUserId(room)) | async"
                 [attr.aria-label]="getRoomDisplayName(room) + ' is online'">
            </div>
          </div>
          
          <div class="room-info">
            <div class="room-header">
              <span class="room-name">{{ getRoomDisplayName(room) }}</span>
              <span class="room-time" *ngIf="room.lastMessageAt">
                {{ formatRoomTime(room.lastMessageAt) }}
              </span>
            </div>
            
            <div class="room-preview">
              <p class="last-message">
                {{ room.lastMessage || 'No messages yet' }}
              </p>
              <div class="room-badges" *ngIf="room.unreadCount > 0">
                <span class="unread-badge">{{ room.unreadCount }}</span>
              </div>
            </div>
            
            <!-- Delivery Info -->
            <div class="delivery-info" *ngIf="room.deliveryAddress">
              <small class="delivery-address">
                <i class="location-icon">üìç</i>
                {{ room.deliveryAddress }}
              </small>
            </div>
          </div>
        </div>
      </div>

      <!-- Empty State for Chat Rooms -->
      <div *ngIf="!isLoading && rooms.length === 0" class="empty-rooms">
        <div class="empty-icon">üì¶</div>
        <p>No active deliveries</p>
        <small>Your delivery chats will appear here</small>
      </div>
    </div>
  </div>

  <!-- Main Chat Area -->
  <div class="chat-main" [class.sidebar-collapsed]="isSidebarCollapsed">
    
    <!-- No Chat Selected State -->
    <div *ngIf="!selectedRoom" class="no-chat-selected">
      <div class="no-chat-content">
        <div class="no-chat-icon">üí¨</div>
        <h3>Select a delivery to start chatting</h3>
        <p>Choose a delivery from the sidebar to chat with your delivery person</p>
      </div>
    </div>

    <!-- Chat Container (existing chat interface) -->
    <div *ngIf="selectedRoom" class="chat-container">
      
      <!-- Header Section -->
      <div class="chat-header">
        <button class="back-button" 
                *ngIf="isMobile"
                (click)="showSidebar()"
                [attr.aria-label]="'Back to delivery list'">
          ‚Äπ
        </button>
        
        <div class="user-info" *ngIf="isOtherUserLoaded(); else loadingUser">
          <div class="user-avatar">
            <div class="avatar-circle">
              {{ getOtherUserFirstName().charAt(0).toUpperCase() }}
            </div>
            <div class="online-indicator" *ngIf="isOnline$ | async" 
                 [attr.aria-label]="getOtherUserFirstName() + ' is online'">
            </div>
          </div>
          <div class="user-details">
            <h3 class="user-name">{{ getOtherUserDisplayName() }}</h3>
            <div class="user-status">
              <span *ngIf="isOnline$ | async; else offlineStatus" class="status-online">
                Online
              </span>
              <ng-template #offlineStatus>
                <span class="status-offline">Offline</span>
              </ng-template>
            </div>
            <!-- Delivery Status -->
            <div class="delivery-status" *ngIf="selectedRoom.deliveryStatus">
              <span class="status-badge" 
                    [class]="'status-' + selectedRoom.deliveryStatus?.toLowerCase()">
                {{ selectedRoom.deliveryStatus }}
              </span>
            </div>
          </div>
        </div>
        
        <ng-template #loadingUser>
          <div class="user-info loading">
            <div class="skeleton-avatar"></div>
            <div class="skeleton-text">
              <div class="skeleton-line short"></div>
              <div class="skeleton-line shorter"></div>
            </div>
          </div>
        </ng-template>

        <!-- Connection Status -->
        <div class="connection-status" *ngIf="isConnecting || hasError">
          <div *ngIf="isConnecting" class="connecting-indicator">
            <div class="spinner"></div>
            <span>Connecting...</span>
          </div>
          <div *ngIf="hasError && !isConnecting" class="error-indicator">
            <span class="error-icon">‚ö†</span>
            <span>{{ errorMessage }}</span>
            <button *ngIf="canRetry" 
                    class="retry-btn" 
                    (click)="retryConnection()"
                    [attr.aria-label]="'Retry connection'">
              Retry
            </button>
          </div>
        </div>
      </div>

      <!-- Messages Section -->
      <div class="messages-section">
        <div #messagesContainer 
             class="messages-container" 
             [class.loading]="isLoading"
             role="log" 
             aria-live="polite" 
             aria-label="Chat messages">
          
          <!-- Loading More Messages Indicator -->
          <div *ngIf="isLoadingMore" class="load-more-indicator">
            <div class="spinner small"></div>
            <span>Loading more messages...</span>
          </div>
          
          <!-- Messages List -->
          <div class="messages-list">
            <div *ngFor="let message of messages; trackBy: trackByMessageId" 
                 class="message-wrapper"
                 [class.own-message]="isOwnMessage(message)"
                 [class.other-message]="!isOwnMessage(message)"
                 [attr.data-message-id]="message.id">
              
              <div class="message-bubble">
                <div class="message-content">
                  {{ message.content }}
                </div>
                
                <div class="message-meta">
                  <span class="message-time" *ngIf="isValidDate(message.timestamp)">
                    {{ formatMessageTime(message.timestamp) }}
                  </span>
                  
                  <!-- Message Status (only for own messages) -->
                  <div *ngIf="isOwnMessage(message)" class="message-status">
                    <span [ngSwitch]="message.status" class="status-icon">
                      <span *ngSwitchCase="MessageStatus.SENT">‚úì</span>
                      <span *ngSwitchCase="MessageStatus.DELIVERED">‚úì‚úì</span>
                      <span *ngSwitchCase="MessageStatus.READ">‚úì‚úì</span>
                      <span *ngSwitchCase="MessageStatus.FAILED" class="failed">‚úó</span>
                      <span *ngSwitchDefault>‚è≥</span>
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Typing Indicator -->
            <div *ngIf="(typingUsers$ | async)?.length" class="typing-indicator">
              <div class="typing-bubble">
                <div class="typing-dots">
                  <span></span>
                  <span></span>
                  <span></span>
                </div>
              </div>
              <span class="typing-text">{{ getOtherUserFirstName() }} is typing...</span>
            </div>
          </div>
          
          <!-- Empty State -->
          <div *ngIf="messages.length === 0 && !isLoading" class="empty-state">
            <div class="empty-icon">üí¨</div>
            <p>No messages yet. Start the conversation!</p>
            <small>Say hello to your delivery person</small>
          </div>
        </div>

        <!-- Quick Messages for Clients -->
        <div class="quick-messages" *ngIf="!isLoading && !hasError && selectedRoom">
          <button *ngFor="let quickMsg of quickMessages" 
                  class="quick-message-btn"
                  (click)="setQuickMessage(quickMsg)"
                  [attr.aria-label]="'Set quick message: ' + quickMsg">
            {{ quickMsg }}
          </button>
        </div>
      </div>

      <!-- Input Section -->
      <div class="input-section" *ngIf="selectedRoom">
        <form class="message-form" 
              (ngSubmit)="sendMessage()" 
              [class.disabled]="isInputDisabled">
          
          <div class="input-container">
            <textarea #messageInput
                      [(ngModel)]="newMessage"
                      name="message"
                      class="message-input"
                      placeholder="Type your message..."
                      rows="1"
                      maxlength="1000"
                      [disabled]="isInputDisabled"
                      (input)="onTyping()"
                      (keydown)="onEnterKey($event)"
                      (blur)="onBlurMessageInput()"
                      [attr.aria-label]="'Message input'">
            </textarea>
            
            <button type="submit" 
                    class="send-button"
                    [disabled]="!canSendMessage()"
                    [class.sending]="state.sendingMessage"
                    [attr.aria-label]="'Send message'">
              <span *ngIf="!state.sendingMessage" class="send-icon">‚û§</span>
              <div *ngIf="state.sendingMessage" class="spinner small"></div>
            </button>
          </div>
          
          <div class="input-meta">
            <span class="char-count" 
                  [class.near-limit]="newMessage.length > 900"
                  [class.at-limit]="newMessage.length >= 1000">
              {{ newMessage.length }}/1000
            </span>
          </div>
        </form>
      </div>
    </div>

    <!-- Loading Overlay -->
    <div *ngIf="isLoading && rooms.length === 0" class="loading-overlay">
      <div class="loading-content">
        <div class="spinner large"></div>
        <p>Loading deliveries...</p>
      </div>
    </div>
  </div>
</div>

<style>
/* Include all the styles from the previous artifact, plus these client-specific additions */

/* Client-specific delivery info */
.delivery-info {
  margin-top: 4px;
  padding-top: 4px;
  border-top: 1px solid rgba(0, 0, 0, 0.05);
}

.chat-room-item.active .delivery-info {
  border-top-color: rgba(255, 255, 255, 0.2);
}

.delivery-address {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 12px;
  color: #6b7280;
  line-height: 1.3;
}

.chat-room-item.active .delivery-address {
  color: rgba(255, 255, 255, 0.8);
}

.location-icon {
  font-size: 10px;
  flex-shrink: 0;
}

/* Delivery status in header */
.delivery-status {
  margin-top: 4px;
}

.status-badge {
  font-size: 11px;
  padding: 2px 8px;
  border-radius: 12px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.status-badge.status-pending {
  background: rgba(245, 158, 11, 0.2);
  color: #f59e0b;
}

.status-badge.status-in-transit {
  background: rgba(59, 130, 246, 0.2);
  color: #3b82f6;
}

.status-badge.status-out-for-delivery {
  background: rgba(16, 185, 129, 0.2);
  color: #10b981;
}

.status-badge.status-delivered {
  background: rgba(34, 197, 94, 0.2);
  color: #22c55e;
}

.status-badge.status-failed {
  background: rgba(239, 68, 68, 0.2);
  color: #ef4444;
}

/* Client-specific empty state */
.empty-rooms .empty-icon {
  font-size: 48px;
}

.no-chat-selected .no-chat-content {
  color: #6b7280;
}

.no-chat-selected .no-chat-content h3 {
  color: #374151;
}

/* Client-specific room title */
.sidebar-title h3 {
  color: #1f2937;
}

/* Mobile overlay for sidebar */
@media (max-width: 768px) {
  .chat-sidebar.show-mobile {
    transform: translateX(0);
    box-shadow: 4px 0 12px rgba(0, 0, 0, 0.15);
  }
}

/* Client quick messages styling */
.quick-messages .quick-message-btn {
  font-size: 13px;
  color: #374151;
}

.quick-messages .quick-message-btn:hover {
  color: #1f2937;
}

/* Enhanced loading state for deliveries */
.loading-overlay p {
  margin-top: 16px;
  font-size: 16px;
  color: #6b7280;
}
</style>