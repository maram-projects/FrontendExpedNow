<!-- AI Assistant Chat Widget -->
<div class="ai-assistant-widget" [class.minimized]="isMinimized">
  <!-- Chat Toggle Button -->
  <button class="chat-toggle-btn" 
          (click)="toggleChat()" 
          [class.has-messages]="messages.length > 0"
          title="AI Assistant">
    <i class="fas fa-robot" *ngIf="isMinimized"></i>
    <i class="fas fa-times" *ngIf="!isMinimized"></i>
    <span class="message-count" *ngIf="messages.length > 0 && isMinimized">
      {{ messages.length }}
    </span>
  </button>

  <!-- Chat Container -->
  <div class="chat-container" *ngIf="!isMinimized">
    <!-- Chat Header -->
    <div class="chat-header">
      <div class="assistant-info">
        <div class="assistant-avatar">
          <i class="fas fa-robot"></i>
        </div>
        <div class="assistant-details">
          <h6 class="assistant-name">ExpedNow Assistant</h6>
          <p class="assistant-status">
            <span class="status-indicator online"></span>
            Always here to help
          </p>
        </div>
      </div>
      <div class="chat-actions">
        <button class="btn-icon" 
                (click)="startNewConversation()" 
                title="New Conversation"
                *ngIf="messages.length > 0">
          <i class="fas fa-plus"></i>
        </button>
        <button class="btn-icon" 
                (click)="clearConversation()" 
                title="Clear Chat"
                *ngIf="messages.length > 0">
          <i class="fas fa-trash"></i>
        </button>
        <button class="btn-icon" (click)="toggleChat()" title="Minimize">
          <i class="fas fa-minus"></i>
        </button>
      </div>
    </div>

    <!-- Messages Container -->
    <div class="messages-container" #messagesContainer>
      <!-- Welcome Message -->
      <div class="welcome-message" *ngIf="messages.length === 0">
        <div class="welcome-avatar">
          <i class="fas fa-robot"></i>
        </div>
        <div class="welcome-content">
          <h6>Hello, {{ getUserName() }}! ðŸ‘‹</h6>
          <p>I'm your ExpedNow AI Assistant. I can help you with:</p>
          <ul class="help-features">
            <li><i class="fas fa-truck"></i> Track your deliveries</li>
            <li><i class="fas fa-chart-line"></i> View delivery statistics</li>
            <li><i class="fas fa-credit-card"></i> Check payment status</li>
            <li><i class="fas fa-question-circle"></i> Answer questions about our service</li>
          </ul>
        </div>
      </div>

      <!-- Messages -->
      <div class="messages-list" *ngIf="messages.length > 0">
        <div *ngFor="let message of messages; trackBy: trackByMessage" 
             [ngClass]="getMessageClass(message)">
          <div class="message-avatar" *ngIf="isAssistantMessage(message)">
            <i class="fas fa-robot"></i>
          </div>
          <div class="message-content">
            <div class="message-bubble">
              <p [innerHTML]="formatMessageContent(message.content)"></p>
              <div class="message-time">
                {{ formatTimestamp(message.timestamp) }}
              </div>
            </div>
          </div>
          <div class="message-avatar user-avatar" *ngIf="isUserMessage(message)">
            <i class="fas fa-user"></i>
          </div>
        </div>
      </div>

      <!-- Typing Indicator -->
      <div class="typing-indicator" *ngIf="isTyping">
        <div class="message assistant-message">
          <div class="message-avatar">
            <i class="fas fa-robot"></i>
          </div>
          <div class="message-content">
            <div class="message-bubble">
              <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Questions -->
      <div class="quick-questions" *ngIf="showQuickQuestions && !isLoading">
        <h6 class="quick-questions-title">Quick questions you can ask:</h6>
        <div class="questions-grid">
          <button *ngFor="let question of quickQuestions.slice(0, 4)" 
                  class="quick-question-btn"
                  (click)="sendQuickQuestion(question)">
            {{ question }}
          </button>
        </div>
      </div>
    </div>

    <!-- Message Input -->
    <div class="message-input-container">
      <div class="input-wrapper">
        <textarea #messageInput
                  [(ngModel)]="currentMessage"
                  (keydown)="onKeyPress($event)"
                  placeholder="Ask me anything about your deliveries..."
                  class="message-input"
                  rows="1"
                  [disabled]="isLoading"></textarea>
        <button class="send-btn" 
                (click)="sendMessage()" 
                [disabled]="!currentMessage.trim() || isLoading">
          <i class="fas fa-paper-plane" *ngIf="!isLoading"></i>
          <i class="fas fa-spinner fa-spin" *ngIf="isLoading"></i>
        </button>
      </div>
      <div class="input-hint">
        <i class="fas fa-lightbulb"></i>
        Press Enter to send, Shift+Enter for new line
      </div>
    </div>
  </div>
</div>