<!-- Enhanced chat-component.component.html with left sidebar for chat rooms -->
<div class="chat-layout" [class.loading]="isLoading" [class.error]="hasError">
  
  <!-- Left Sidebar - Chat Rooms List -->
  <div class="chat-sidebar" [class.collapsed]="isSidebarCollapsed">
    <div class="sidebar-header">
      <div class="sidebar-title">
        <h3>Chats</h3>
        <span class="chat-count" *ngIf="rooms.length > 0">({{ rooms.length }})</span>
      </div>
      <button class="sidebar-toggle" 
              (click)="toggleSidebar()"
              [attr.aria-label]="isSidebarCollapsed ? 'Expand sidebar' : 'Collapse sidebar'">
        <span class="toggle-icon" [class.collapsed]="isSidebarCollapsed">‚Äπ</span>
      </button>
    </div>

    <!-- Chat Rooms List -->
    <div class="chat-rooms-container">
      <div *ngIf="isLoading && rooms.length === 0" class="loading-rooms">
        <div class="skeleton-room" *ngFor="let item of [1,2,3]">
          <div class="skeleton-avatar"></div>
          <div class="skeleton-content">
            <div class="skeleton-line"></div>
            <div class="skeleton-line short"></div>
          </div>
        </div>
      </div>

      <div class="chat-rooms-list" *ngIf="!isLoading || rooms.length > 0">
        <div *ngFor="let room of rooms; trackBy: trackByRoomId"
             class="chat-room-item"
             [class.active]="selectedRoom?.deliveryId === room.deliveryId"
             [class.has-unread]="room.unreadCount > 0"
             (click)="selectRoom(room)"
             role="button"
             [attr.aria-label]="'Chat with ' + getRoomDisplayName(room)">
          
          <div class="room-avatar">
            <div class="avatar-circle">
              {{ getRoomDisplayName(room).charAt(0).toUpperCase() }}
            </div>
            <div class="online-indicator" 
                 *ngIf="isUserOnline(getOtherUserId(room)) | async"
                 [attr.aria-label]="getRoomDisplayName(room) + ' is online'">
            </div>
          </div>
          
          <div class="room-info">
            <div class="room-header">
              <span class="room-name">{{ getRoomDisplayName(room) }}</span>
              <span class="room-time" *ngIf="room.lastMessageAt">
                {{ formatRoomTime(room.lastMessageAt) }}
              </span>
            </div>
            
            <div class="room-preview">
              <p class="last-message">
                {{ room.lastMessage || 'No messages yet' }}
              </p>
              <div class="room-badges" *ngIf="room.unreadCount > 0">
                <span class="unread-badge">{{ room.unreadCount }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Empty State for Chat Rooms -->
      <div *ngIf="!isLoading && rooms.length === 0" class="empty-rooms">
        <div class="empty-icon">üí¨</div>
        <p>No active chats</p>
        <small>Start a conversation from your deliveries</small>
      </div>
    </div>
  </div>

  <!-- Main Chat Area -->
  <div class="chat-main" [class.sidebar-collapsed]="isSidebarCollapsed">
    
    <!-- No Chat Selected State -->
    <div *ngIf="!selectedRoom" class="no-chat-selected">
      <div class="no-chat-content">
        <div class="no-chat-icon">üí¨</div>
        <h3>Select a chat to start messaging</h3>
        <p>Choose a conversation from the sidebar to begin chatting</p>
      </div>
    </div>

    <!-- Chat Container (existing chat interface) -->
    <div *ngIf="selectedRoom" class="chat-container">
      
      <!-- Header Section -->
      <div class="chat-header">
        <button class="back-button" 
                *ngIf="isMobile"
                (click)="showSidebar()"
                [attr.aria-label]="'Back to chat list'">
          ‚Äπ
        </button>
        
        <div class="user-info" *ngIf="isOtherUserLoaded(); else loadingUser">
          <div class="user-avatar">
            <div class="avatar-circle">
              {{ getOtherUserFirstName().charAt(0).toUpperCase() }}
            </div>
            <div class="online-indicator" *ngIf="isOnline$ | async" 
                 [attr.aria-label]="getOtherUserFirstName() + ' is online'">
            </div>
          </div>
          <div class="user-details">
            <h3 class="user-name">{{ getOtherUserDisplayName() }}</h3>
            <div class="user-status">
              <span *ngIf="isOnline$ | async; else offlineStatus" class="status-online">
                Online
              </span>
              <ng-template #offlineStatus>
                <span class="status-offline">Offline</span>
              </ng-template>
            </div>
          </div>
        </div>
        
        <ng-template #loadingUser>
          <div class="user-info loading">
            <div class="skeleton-avatar"></div>
            <div class="skeleton-text">
              <div class="skeleton-line short"></div>
              <div class="skeleton-line shorter"></div>
            </div>
          </div>
        </ng-template>

        <!-- Connection Status -->
        <div class="connection-status" *ngIf="isConnecting || hasError">
          <div *ngIf="isConnecting" class="connecting-indicator">
            <div class="spinner"></div>
            <span>Connecting...</span>
          </div>
          <div *ngIf="hasError && !isConnecting" class="error-indicator">
            <span class="error-icon">‚ö†</span>
            <span>{{ errorMessage }}</span>
            <button *ngIf="canRetry" 
                    class="retry-btn" 
                    (click)="retryConnection()"
                    [attr.aria-label]="'Retry connection'">
              Retry
            </button>
          </div>
        </div>
      </div>

      <!-- Messages Section -->
      <div class="messages-section">
        <div #messagesContainer 
             class="messages-container" 
             [class.loading]="isLoading"
             role="log" 
             aria-live="polite" 
             aria-label="Chat messages">
          
          <!-- Loading More Messages Indicator -->
          <div *ngIf="isLoadingMore" class="load-more-indicator">
            <div class="spinner small"></div>
            <span>Loading more messages...</span>
          </div>
          
          <!-- Messages List -->
          <div class="messages-list">
            <div *ngFor="let message of messages; trackBy: trackByMessageId" 
                 class="message-wrapper"
                 [class.own-message]="isOwnMessage(message)"
                 [class.other-message]="!isOwnMessage(message)"
                 [attr.data-message-id]="message.id">
              
              <div class="message-bubble">
                <div class="message-content">
                  {{ message.content }}
                </div>
                
                <div class="message-meta">
                  <span class="message-time" *ngIf="isValidDate(message.timestamp)">
                    {{ formatMessageTime(message.timestamp) }}
                  </span>
                  
                  <!-- Message Status (only for own messages) -->
                  <div *ngIf="isOwnMessage(message)" class="message-status">
                    <span [ngSwitch]="message.status" class="status-icon">
                      <span *ngSwitchCase="MessageStatus.SENT">‚úì</span>
                      <span *ngSwitchCase="MessageStatus.DELIVERED">‚úì‚úì</span>
                      <span *ngSwitchCase="MessageStatus.READ">‚úì‚úì</span>
                      <span *ngSwitchCase="MessageStatus.FAILED" class="failed">‚úó</span>
                      <span *ngSwitchDefault>‚è≥</span>
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Typing Indicator -->
            <div *ngIf="(typingUsers$ | async)?.length" class="typing-indicator">
              <div class="typing-bubble">
                <div class="typing-dots">
                  <span></span>
                  <span></span>
                  <span></span>
                </div>
              </div>
              <span class="typing-text">{{ getOtherUserFirstName() }} is typing...</span>
            </div>
          </div>
          
          <!-- Empty State -->
          <div *ngIf="messages.length === 0 && !isLoading" class="empty-state">
            <div class="empty-icon">üí¨</div>
            <p>No messages yet. Start the conversation!</p>
          </div>
        </div>

        <!-- Quick Messages (Optional) -->
        <div class="quick-messages" *ngIf="!isLoading && !hasError && selectedRoom">
          <button *ngFor="let quickMsg of quickMessages" 
                  class="quick-message-btn"
                  (click)="setQuickMessage(quickMsg)"
                  [attr.aria-label]="'Set quick message: ' + quickMsg">
            {{ quickMsg }}
          </button>
        </div>
      </div>

      <!-- Input Section -->
      <div class="input-section" *ngIf="selectedRoom">
        <form class="message-form" 
              (ngSubmit)="sendMessage()" 
              [class.disabled]="isInputDisabled">
          
          <div class="input-container">
            <textarea #messageInput
                      [(ngModel)]="newMessage"
                      name="message"
                      class="message-input"
                      placeholder="Type your message..."
                      rows="1"
                      maxlength="1000"
                      [disabled]="isInputDisabled"
                      (input)="onTyping()"
                      (keydown)="onEnterKey($event)"
                      (blur)="onBlurMessageInput()"
                      [attr.aria-label]="'Message input'">
            </textarea>
            
            <button type="submit" 
                    class="send-button"
                    [disabled]="!canSendMessage()"
                    [class.sending]="state.sendingMessage"
                    [attr.aria-label]="'Send message'">
              <span *ngIf="!state.sendingMessage" class="send-icon">‚û§</span>
              <div *ngIf="state.sendingMessage" class="spinner small"></div>
            </button>
          </div>
          
          <div class="input-meta">
            <span class="char-count" 
                  [class.near-limit]="newMessage.length > 900"
                  [class.at-limit]="newMessage.length >= 1000">
              {{ newMessage.length }}/1000
            </span>
          </div>
        </form>
      </div>
    </div>

    <!-- Loading Overlay -->
    <div *ngIf="isLoading && rooms.length === 0" class="loading-overlay">
      <div class="loading-content">
        <div class="spinner large"></div>
        <p>Loading chat...</p>
      </div>
    </div>
  </div>
</div>