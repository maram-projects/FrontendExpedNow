<!-- chatbot.component.html - Interface Moderne & Professionnelle -->

<!-- Bouton Flottant Moderne du Chatbot -->
<div class="chatbot-toggle"
     [class.open]="isOpen()"
     (click)="toggleChat()"
     (mousedown)="startLongPress()"
     (mouseup)="endLongPress()"
     (mouseleave)="endLongPress()"
     (touchstart)="startLongPress()"
     (touchend)="endLongPress()">
  
  <!-- Tooltip -->
  <div class="chatbot-tooltip">
    {{ isOpen() ? 'Fermer l\'assistant IA' : 'Assistant IA - Cliquez pour discuter' }}
  </div>
  
  <!-- IcÃ´ne Principale -->
  <i class="fas" 
     [class.fa-robot]="!isOpen()"
     [class.fa-times]="isOpen()"></i>
  
  <!-- Indicateur d'Ã‰tat de Connexion -->
  <span class="connection-status" 
        [class.offline]="!isConnected()"
        [class.authenticated]="isConnected() && isAuthenticated()"
        [title]="getConnectionStatusText()"></span>
  
  <!-- Badge de Notification -->
  @if (messageCount() > 1 && !isOpen()) {
    <span class="notification-badge">{{ messageCount() - 1 }}</span>
  }
  
  <!-- Menu Actions Rapides (apparaÃ®t lors d'un appui long) -->
  <div class="quick-actions" [class.show]="showQuickActions()">
    <button class="quick-action-btn" 
            (click)="executeQuickAction('stats')"
            type="button">
      ğŸ“Š Afficher les statistiques
    </button>
    <button class="quick-action-btn" 
            (click)="executeQuickAction('users')"
            type="button">
      ğŸ‘¥ Utilisateurs actifs
    </button>
    <button class="quick-action-btn" 
            (click)="executeQuickAction('help')"
            type="button">
      ğŸ’¡ Aide
    </button>
    <button class="quick-action-btn" 
            (click)="executeQuickAction('reports')"
            type="button">
      ğŸ“ˆ Rapports
    </button>
  </div>
</div>

<!-- FenÃªtre du Chatbot -->
<div class="chatbot-window" [class.open]="isOpen()">
  <!-- En-tÃªte AmÃ©liorÃ© -->
  <div class="chatbot-header">
    <div class="header-info">
      <h3>ğŸ¤– Assistant Administratif IA</h3>
      <span class="status" [class.offline]="!isConnected()">
        {{ getConnectionStatusText() }}
        @if (isAuthenticated()) {
          <i class="fas fa-shield-alt" style="margin-left: 5px;"></i>
        }
      </span>
    </div>
    <div class="header-actions">
      <!-- Bouton Actualiser/RÃ©essayer -->
      @if (shouldShowRetryButton()) {
        <button class="btn-retry"
                (click)="retryConnection()"
                title="RÃ©essayer"
                type="button">
          <i class="fas fa-redo"></i>
        </button>
      }
      
      <!-- Bouton Effacer la Conversation -->
      <button class="btn-clear"
              (click)="clearChat()"
              title="Effacer la conversation"
              [disabled]="messageCount() <= 1"
              type="button">
        <i class="fas fa-trash"></i>
      </button>
      
      <!-- Bouton Minimiser/Fermer -->
      <button class="btn-close"
              (click)="toggleChat()"
              title="Minimiser"
              type="button">
        <i class="fas fa-minus"></i>
      </button>
    </div>
  </div>

  <!-- Zone de Messages AmÃ©liorÃ©e -->
  <div class="chatbot-messages" #messagesContainer>
    @for (message of messages(); track trackByMessage($index, message)) {
      <div class="message" [class]="message.sender">
        <div class="message-content">
          <!-- Message avec meilleur formatage -->
          <div [innerHTML]="formatMessage(message.text)"></div>
          <span class="message-time">
            <i class="fas fa-clock" style="margin-right: 4px;"></i>
            {{ formatTime(message.timestamp) }}
          </span>
        </div>
      </div>
    }

    <!-- Indicateur de Frappe AmÃ©liorÃ© -->
    @if (isTyping()) {
      <div class="message bot typing-indicator">
        <div class="message-content">
          <div class="typing-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
          <span class="typing-text">
            <i class="fas fa-robot" style="margin-right: 5px;"></i>
            L'assistant Ã©crit...
          </span>
        </div>
      </div>
    }

    <!-- Message d'Ã‰tat de Connexion AmÃ©liorÃ© -->
    @if (!isConnected() && messageCount() > 0) {
      <div class="connection-message">
        <i class="fas fa-wifi-slash"></i>
        <span>Connexion perdue - VÃ©rifiez votre internet</span>
        @if (shouldShowRetryButton()) {
          <button class="retry-btn" 
                  (click)="retryConnection()"
                  type="button">
            <i class="fas fa-redo"></i>
            RÃ©essayer
          </button>
        }
      </div>
    }

    <!-- Message de Bienvenue/Aide -->
    @if (messageCount() === 1 && !isTyping()) {
      <div class="welcome-suggestions">
        <div class="suggestion-title">ğŸ’¡ Suggestions rapides :</div>
        <div class="suggestions-grid">
          <button class="suggestion-btn" 
                  (click)="sendQuickMessage('Quelles sont les derniÃ¨res statistiques ?')"
                  type="button">
            ğŸ“Š Statistiques
          </button>
          <button class="suggestion-btn" 
                  (click)="sendQuickMessage('Combien d\'utilisateurs sont actifs ?')"
                  type="button">
            ğŸ‘¥ Utilisateurs
          </button>
          <button class="suggestion-btn" 
                  (click)="sendQuickMessage('Afficher les rapports quotidiens')"
                  type="button">
            ğŸ“ˆ Rapports
          </button>
          <button class="suggestion-btn" 
                  (click)="sendQuickMessage('Comment puis-je gÃ©rer le systÃ¨me ?')"
                  type="button">
            âš™ï¸ Aide
          </button>
        </div>
      </div>
    }
  </div>

  <!-- Zone de Saisie AmÃ©liorÃ©e -->
  <div class="chatbot-input">
    <!-- Conteneur de Saisie Principal -->
    <div class="input-container">
      <textarea
        [(ngModel)]="userInputValue"
        (keydown)="onKeyPress($event)"
        (input)="onInputChange($any($event.target).value)"
        placeholder="Tapez votre message ici... (Appuyez sur EntrÃ©e pour envoyer)"
        class="message-input"
        rows="1"
        [disabled]="!isConnected() || isTyping()"
        maxlength="500"
        autocomplete="off"
        autocorrect="off"
        spellcheck="false">
      </textarea>

      <!-- Bouton d'Envoi AmÃ©liorÃ© -->
      <button
        class="send-button"
        (click)="sendMessage()"
        [disabled]="!canSend()"
        [title]="canSend() ? 'Envoyer (EntrÃ©e)' : getDisabledReason()"
        type="button">
        @if (isTyping()) {
          <i class="fas fa-spinner fa-spin"></i>
        } @else if (canSend()) {
          <i class="fas fa-paper-plane"></i>
        } @else {
          <i class="fas fa-ban"></i>
        }
      </button>
    </div>

    <!-- Pied de Page de Saisie AmÃ©liorÃ© -->
    <div class="input-footer">
      <div class="footer-left">
        <!-- Compteur de CaractÃ¨res -->
        <span class="char-counter"
              [class.warning]="userInput().length > 450"
              [class.danger]="userInput().length >= 500">
          <i class="fas fa-keyboard" style="margin-right: 4px;"></i>
          {{ userInput().length }}/500
        </span>
      </div>

      <div class="footer-right">
        @if (!isConnected()) {
          <span class="connection-warning">
            <i class="fas fa-exclamation-triangle"></i>
            Pas de connexion
          </span>
        } @else if (isTyping()) {
          <span class="typing-status">
            <i class="fas fa-circle-notch fa-spin"></i>
            Envoi en cours...
          </span>
        } @else if (isConnected()) {
          <span class="online-status">
            <i class="fas fa-check-circle"></i>
            ConnectÃ©
          </span>
        }
      </div>
    </div>

    <!-- Actions Rapides AmÃ©liorÃ©es (Toujours visibles quand connectÃ©) -->
    @if (isConnected() && !isTyping() && messageCount() > 1) {
      <div class="quick-actions">
        <button class="quick-action-btn" 
                (click)="sendQuickMessage('ğŸ“Š Afficher les statistiques actuelles')"
                type="button">
          ğŸ“Š Statistiques
        </button>
        <button class="quick-action-btn" 
                (click)="sendQuickMessage('ğŸ‘¥ Combien d\'utilisateurs sont actifs ?')"
                type="button">
          ğŸ‘¥ Utilisateurs
        </button>
        <button class="quick-action-btn" 
                (click)="sendQuickMessage('ğŸ’° Afficher les revenus')"
                type="button">
          ğŸ’° Revenus
        </button>
        <button class="quick-action-btn" 
                (click)="sendQuickMessage('â“ Aide')"
                type="button">
          â“ Aide
        </button>
      </div>
    }
  </div>
</div>

<!-- Superposition AmÃ©liorÃ©e pour mobile -->
@if (isOpen()) {
  <div class="chatbot-overlay" 
       [class.show]="isOpen()"
       (click)="toggleChat()"></div>
}